<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/favicon.png" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.jwang.cloud","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":true,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":5,"unescape":false,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="0.笔记格式说明">
<meta property="og:type" content="article">
<meta property="og:title" content="Django框架05--语法整理">
<meta property="og:url" content="https://www.jwang.cloud/jwangcloud/663967090/index.html">
<meta property="og:site_name" content="jwangcloud">
<meta property="og:description" content="0.笔记格式说明">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jwangtec.oss-cn-chengdu.aliyuncs.com/jwangcloud/index/Django.jpeg">
<meta property="article:published_time" content="2019-06-05T10:18:19.000Z">
<meta property="article:modified_time" content="2021-12-21T05:00:02.465Z">
<meta property="article:author" content="jwangtec">
<meta property="article:tag" content="python">
<meta property="article:tag" content="Django">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jwangtec.oss-cn-chengdu.aliyuncs.com/jwangcloud/index/Django.jpeg">

<link rel="canonical" href="https://www.jwang.cloud/jwangcloud/663967090/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Django框架05--语法整理 | jwangcloud</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">jwangcloud</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/JwangTec" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.jwang.cloud/jwangcloud/663967090/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="jwangtec">
      <meta itemprop="description" content="小脑袋，大智慧">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jwangcloud">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Django框架05--语法整理
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-06-05 18:18:19" itemprop="dateCreated datePublished" datetime="2019-06-05T18:18:19+08:00">2019-06-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-12-21 13:00:02" itemprop="dateModified" datetime="2021-12-21T13:00:02+08:00">2021-12-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python-Django/" itemprop="url" rel="index"><span itemprop="name">python-Django</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/jwangcloud/663967090/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/jwangcloud/663967090/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>83k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1:15</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><img data-src="https://jwangtec.oss-cn-chengdu.aliyuncs.com/jwangcloud/index/Django.jpeg"></p>
<h2 id="0-笔记格式说明"><a href="#0-笔记格式说明" class="headerlink" title="0.笔记格式说明"></a>0.笔记格式说明</h2><span id="more"></span>

<ol>
<li>代码位置的表示</li>
</ol>
<p>笔记中会有很多代码,比如</p>
<blockquote>
<p>mytest.views.py</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from django.contrib.auth.models import User</span><br><span class="line">from rest_framework import serializers, viewsets</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ol>
<li>mytest.views.py表示在根目录下面的 mytest文件夹 下面的views.py中<br>写入或者查找这些代码</li>
<li>下面那边表示代码</li>
<li>… 三个省略号表示已有代码,需要你到代码中去查看</li>
</ol>
<h2 id="1-restful-api简介"><a href="#1-restful-api简介" class="headerlink" title="1. restful api简介"></a>1. restful api简介</h2><ol>
<li><p>作用:关于如何去设计url的,url的设计其实是很麻烦</p>
</li>
<li><p>观点: url表示了网站的资源</p>
<ol>
<li>URL(Uniform Resoure Locator):统一资源定位符</li>
<li>我们是去通过URL去操控网站里面的资源(数据)</li>
<li>这个Url或者资源他是静态的</li>
</ol>
</li>
<li><p>关于资源的操作(动态的)</p>
<ol>
<li>获取 GET方法</li>
<li>修改 PUT PATCH修改</li>
<li>删除 DELETE</li>
<li>新加 POST</li>
</ol>
</li>
<li><p>思考 comments/delete url的问题</p>
<pre><code> 答案: 以restful标准去设计url的话,他所有的url都是表示静态资源的,他不能有动词
</code></pre>
</li>
<li><p>login logout 怎么去改写:<br> 答案 : 登录是关于session的操作</p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2014/05/restful_api.html">http://www.ruanyifeng.com/blog/2014/05/restful_api.html</a></p>
</li>
</ol>
<h2 id="2-环境搭建"><a href="#2-环境搭建" class="headerlink" title="2. 环境搭建"></a>2. 环境搭建</h2><ol>
<li><p>需要安装的软件</p>
<ol>
<li>django 1.11版本</li>
<li>django drf 最新版本<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pip install django&#x3D;&#x3D;1.11</span><br><span class="line">pip install djangorestframework</span><br><span class="line">pip install markdown</span><br><span class="line">pip install django-filter</span><br><span class="line">pip install coreapi</span><br></pre></td></tr></table></figure></li>
<li>postman发送get或者post方法的工具<br> <a target="_blank" rel="noopener" href="https://www.getpostman.com/apps">https://www.getpostman.com/apps</a></li>
</ol>
</li>
<li><p>在setting中加入drf app应用</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS &#x3D; (</span><br><span class="line">    ...</span><br><span class="line">    &#39;rest_framework&#39;,</span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在drf_movie_rimi.urls.py中配置url</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from django.conf.urls import include</span><br><span class="line"></span><br><span class="line">urlpatterns &#x3D; [</span><br><span class="line">    ...</span><br><span class="line">    url(r&#39;^api-auth&#x2F;&#39;, include(&#39;rest_framework.urls&#39;))</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>在settings.py中配置drf的权限</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK &#x3D; &#123;</span><br><span class="line">    # Use Django&#39;s standard &#96;django.contrib.auth&#96; permissions,</span><br><span class="line">    # or allow read-only access for unauthenticated users.</span><br><span class="line">    &#39;DEFAULT_PERMISSION_CLASSES&#39;: [</span><br><span class="line">        &#39;rest_framework.permissions.DjangoModelPermissionsOrAnonReadOnly&#39;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>安装drf自动文档生成功能</li>
</ol>
<p>drf_movie_rimi.urls.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from rest_framework.documentation import include_docs_urls</span><br><span class="line"></span><br><span class="line">urlpatterns &#x3D; [</span><br><span class="line">    ...</span><br><span class="line">    url(r&#39;^docs&#x2F;&#39;, include_docs_urls(title&#x3D;&#39;My API title&#39;))</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>访问文档url  <a target="_blank" rel="noopener" href="http://127.0.0.1:8001/docs/">http://127.0.0.1:8001/docs/</a></p>
</blockquote>
<h2 id="3-drf快速上手"><a href="#3-drf快速上手" class="headerlink" title="3. drf快速上手"></a>3. drf快速上手</h2><h3 id="1-示例代码"><a href="#1-示例代码" class="headerlink" title="1. 示例代码"></a>1. 示例代码</h3><ol>
<li>新建一个 test的 app 来实验一下drf</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">startapp mytest</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>书写drf代码</li>
</ol>
<blockquote>
<p>1.定义视图类和视图类需要的序列化类</p>
</blockquote>
<blockquote>
<p>mytest.views.py</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">from django.contrib.auth.models import User</span><br><span class="line">from rest_framework import serializers, viewsets</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 定义序列化数据 把user表里面的 url username mail is_staff字段提取出来</span><br><span class="line">class UserSerializer(serializers.HyperlinkedModelSerializer):</span><br><span class="line">    class Meta:</span><br><span class="line">        #使用哪个数据模型</span><br><span class="line">        model &#x3D; User</span><br><span class="line">        #序列化哪些字段出来</span><br><span class="line">        fields &#x3D; (&#39;url&#39;, &#39;username&#39;, &#39;email&#39;, &#39;is_staff&#39;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class UserViewSet(viewsets.ModelViewSet):</span><br><span class="line">    queryset &#x3D; User.objects.all()</span><br><span class="line">    serializer_class &#x3D; UserSerializer</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>2.定义路由 把mytest的url包含到总url中</p>
</blockquote>
<blockquote>
<p>drf_movie_rimi.urls.py</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from django.conf.urls import url,include</span><br><span class="line">from django.contrib import admin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">urlpatterns &#x3D; [</span><br><span class="line">    ...</span><br><span class="line">    url(r&#39;^mytest&#x2F;&#39;, include(&#39;mytest.urls&#39;)),</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>在mytest的app中定义路由，指向到我们的视图函数</p>
</blockquote>
<blockquote>
<p>mytest.urls.py</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from rest_framework import routers</span><br><span class="line">from mytest.views import UserViewSet</span><br><span class="line">from django.conf.urls import include,url</span><br><span class="line"></span><br><span class="line">router &#x3D; routers.DefaultRouter()</span><br><span class="line">router.register(r&#39;users&#39;, UserViewSet)</span><br><span class="line"></span><br><span class="line">urlpatterns &#x3D; [</span><br><span class="line">    url(r&#39;^&#39;, include(router.urls)),</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>使用 createsuperuser 的api 来新建一个或者几个用户的信息</p>
</li>
<li><p>访问接口 查看数据</p>
</li>
<li><p>代码简单解释</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;mytest&#x2F;users&#x2F;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="4-知识点讲解"><a href="#4-知识点讲解" class="headerlink" title="4. 知识点讲解"></a>4. 知识点讲解</h2><h3 id="1-views"><a href="#1-views" class="headerlink" title="1. views"></a>1. views</h3><ol>
<li><p>drf的views和django原生的views一样,可以返回数据,获取get,post方法的参数,验证数据等等。<br>也可以像之前listview detailview, createview deleteview 一样,直接帮你做列表和单<br>个数据的查询,创建数据,删除数据</p>
</li>
<li><p>基础view 函数视图</p>
<ol>
<li>我们可以像django最基础的函数视图一样,去返回一个报文给http请求,注意我们需要加上装饰器<br>才能运行</li>
</ol>
<p> 定义views</p>
<blockquote>
<p>mytest.view_test1.py</p>
</blockquote>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">from rest_framework.decorators import api_view</span><br><span class="line">from rest_framework.response import Response</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">@api_view()</span><br><span class="line">def hello_world(request):</span><br><span class="line">    return Response(&#123;&quot;message&quot;: &quot;Hello, world!&quot;&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<pre><code>定义url路由
&gt;mytest.urls.py
</code></pre>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">...</span><br><span class="line">from mytest.view_test1 import hello_world</span><br><span class="line"></span><br><span class="line">urlpatterns &#x3D; [</span><br><span class="line">    ...</span><br><span class="line">    url(r&#39;test2&#39;,hello_world),</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<pre><code>如果上面的函数运行成功,我们就可以去通过最简单得函数视图去解决 简单得业务逻辑,如get请求
post请求,但是事情没有那么简单

我们会发现你用post 方法是不行的,需要加上方法的装饰器
&gt;mytest.view_test1.py

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from rest_framework.decorators import api_view</span><br><span class="line">from rest_framework.response import Response</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">@api_view([&#39;GET&#39;, &#39;POST&#39;])</span><br><span class="line">def hello_world(request):</span><br><span class="line">    return Response(&#123;&quot;message&quot;: &quot;Hello, world!&quot;&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</code></pre>
<p>   练习:</p>
<pre><code>  1. 使用postman发送post方法 断点查看request的值,实现一个功能, get post方法过来
分别返回不同的值
  2. 再次观察我们的response
   里面值,我们传递的是一个list或者dict,如果是django的话你会收到一个报错,但是drf里面的response
   会帮我们解析成json数据格式
</code></pre>
<p>   查看其实这个request的值其实是rest_framework的request解析过来的,和我们之间的django request有什么不一样</p>
<ol start="2">
<li>APIView</li>
</ol>
<pre><code>APIView是我们接触到的第一个类视图,就像django的template view一样 是基础的视图类,你需要自己去定义get post
方法,需要自己去定义返回的数据,但是我们可以看到,我们不用自己去解析get方法和post方法,
只用重写get post函数就可以去截取get ost方法传过来的参数

   1. 简单的get post请求
    mytest.view_test1.py
    
    
    
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from rest_framework.views import APIView</span><br><span class="line">from rest_framework.response import Response</span><br><span class="line">from rest_framework import authentication, permissions</span><br><span class="line">from django.contrib.auth.models import User</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">class ListUsers(APIView):</span><br><span class="line"></span><br><span class="line">    def get(self, request, format&#x3D;None):</span><br><span class="line">        return Response(&#123;&quot;get&quot;: &quot;Hello, world!&quot;&#125;)</span><br><span class="line"></span><br><span class="line">    def post(self, request, format&#x3D;None):</span><br><span class="line">            return Response(&#123;&quot;post&quot;: &quot;Hello, world!&quot;&#125;)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>


    定义url路由
    &gt;mytest.urls.py

    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">from mytest.view_test1 import ListUsers</span><br><span class="line"></span><br><span class="line">urlpatterns &#x3D; [</span><br><span class="line">    ...</span><br><span class="line">    url(r&#39;test1&#39;,ListUsers.as_view()),</span><br><span class="line">    ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

   2. APIView里面包含了很多强大的功能,比如我们权限控制

   我们制作一个接口,访问用户数据接口,由于用户信息比较敏感，我们需要授权用户(登录用户)去才能访问
   APIView里面自带了权限验证接口,接口分为两部分:

   1. 通过一定的方式，比如session或者cookie或者其他区识别用户是哪个
       &gt;authentication_classes

   2. 通过识别好的用户身份，去判断他是否由权限使用这个接口
       &gt; permission_classes

   mytest.view_test1.py
   
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from rest_framework.views import APIView</span><br><span class="line">from rest_framework.response import Response</span><br><span class="line">from rest_framework import authentication, permissions</span><br><span class="line"></span><br><span class="line">class ListUsersV2(APIView):</span><br><span class="line"></span><br><span class="line">#通过什么方式来验证用户,这个例子里面是通过token来验证用户信息</span><br><span class="line">authentication_classes &#x3D; (authentication.TokenAuthentication,)</span><br><span class="line">#用户必须是什么级别才能使用这个接口</span><br><span class="line">permission_classes &#x3D; (permissions.IsAdminUser,permissions.IsAuthenticatedOrReadOnly)</span><br><span class="line"></span><br><span class="line">def get(self, request, format&#x3D;None):</span><br><span class="line">    return Response(&#123;&quot;get&quot;: &quot;Hello, world!&quot;&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def post(self, request, format&#x3D;None):</span><br><span class="line">    return Response([username for username in User.objects.all()])</span><br><span class="line"></span><br></pre></td></tr></table></figure>

    定义url路由
    &gt;mytest.urls.py

    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">from mytest.view_test1 import ListUsersV2</span><br><span class="line"></span><br><span class="line">urlpatterns &#x3D; [</span><br><span class="line">    ...</span><br><span class="line">    url(r&#39;test3&#39;,ListUsersV2.as_view()),</span><br><span class="line">    ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

    3. GenericAPIView解析

        1. GenericAPIView解析继承自 APIView 扩展了他的很多功能
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">class GenericAPIView(views.APIView):</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

        2. GenericAPIView的具体功能

            1. 强制要求传递 queryset和serializer_class

            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">queryset &#x3D; None</span><br><span class="line">serializer_class &#x3D; None</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

            2. 为detailview 默认制定pk为查询的依据

            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lookup_field &#x3D; &#39;pk&#39;</span><br><span class="line">lookup_url_kwarg &#x3D; None</span><br></pre></td></tr></table></figure>

            3. 定义 get_queryset get_serializer_class等class,指定分页 扩展第一个功能

            4. 参看 mytest.view_test5.py 我们可以直接调用他的函数，获取序列化的数据
            返回给前端

            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">class UserListTest5V1(generics.GenericAPIView):</span><br><span class="line">   queryset &#x3D; User.objects.all()</span><br><span class="line">   serializer_class &#x3D; UserSerializer</span><br><span class="line"></span><br><span class="line">   def get(self, request, format&#x3D;None):</span><br><span class="line">       serializer &#x3D; self.get_serializer(self.get_queryset(), many&#x3D;True)</span><br><span class="line">       return Response(serializer.data)</span><br></pre></td></tr></table></figure>




4. 访问速度控制

mytest.view_test1.py

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">from rest_framework.throttling import UserRateThrottle</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">class OncePerDayUserThrottle(UserRateThrottle):</span><br><span class="line">    rate &#x3D; &#39;1&#x2F;day&#39;</span><br><span class="line"></span><br><span class="line">class ListUsersV2(APIView):</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">throttle_classes &#x3D; (OncePerDayUserThrottle,)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</code></pre>
<ol start="3">
<li><p>Generic views 封装了一定功能的view类</p>
<ol>
<li><p>简介: 回想django的listview 我们通过这个类无需自己去数据库取东西,<br>只需要告诉他我们的model是什么 模板用什么 他就可以帮我们自动的完成浏览你要<br>访问的model,然后返回给模板数据</p>
</li>
<li><p>ListAPIView 类似于detailview一样 返回给我们所有数据的列表</p>
<ol>
<li><p>queryset 告诉他我们需要使用哪个数据</p>
</li>
<li><p>serializer_class 告诉他我们使用哪个序列化定义</p>
</li>
</ol>
</li>
</ol>
<p> mytest.view_test2.py</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from django.contrib.auth.models import User</span><br><span class="line">from rest_framework import generics</span><br><span class="line">from rest_framework.permissions import IsAdminUser</span><br><span class="line">from rest_framework import serializers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class UserSerializer(serializers.Serializer):</span><br><span class="line">    username &#x3D; serializers.CharField(max_length&#x3D;50)</span><br><span class="line"></span><br><span class="line">class UserList(generics.ListAPIView):</span><br><span class="line">    queryset &#x3D; User.objects.all()</span><br><span class="line">    serializer_class &#x3D; UserSerializer</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> mytest.urls.py</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">...</span><br><span class="line">from mytest.view_test2 import UserList</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">urlpatterns &#x3D; [</span><br><span class="line">    ...</span><br><span class="line">    url(r&#39;test5&#39;,UserList.as_view()),</span><br><span class="line">    url(r&#39;^&#39;, include(router.urls)),</span><br><span class="line"></span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<pre><code>3. ListAPIView解析

    查看他的源码 发现他是由mixins和GenericAPIView组合生成的一个类,
    其中重写了get方法,让get方法去执行mixins里面的list方法

    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class ListAPIView(mixins.ListModelMixin,</span><br><span class="line">                  GenericAPIView):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    Concrete view for listing a queryset.</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    def get(self, request, *args, **kwargs):</span><br><span class="line">        return self.list(request, *args, **kwargs)</span><br></pre></td></tr></table></figure>

    mixins是什么，如何理解mixins就成了理解这个类的关键

4. Mixin解析

    1. 简介:通过上面的ListAPIView 我们可以有了很便捷的方式去获取数据库里面的
    数据 比如通过下面函数我们就可以获取到序列化的数据
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">serializer &#x3D; self.get_serializer(self.get_queryset(), many&#x3D;True)</span><br></pre></td></tr></table></figure>


    2. 但是这样不符合DRY原则,我们每次使用ListAPIView或者APIVIEW
    我们都需要自己的去序列化数据返回给前,我们需要一种方法,他已经给我们
    写好了,我们只需要去继承他,就可以免费的使用它的序列化方法,所有就有了
    Mixins,我们继承mixins其实 就是去让他改写了我们get post等等方法,我们
    就不用想

    3. mixins
        1. ListModelMixin  对应获取列表的方法

        2. RetrieveModelMixin 对应获获取一条数据

        3. CreateModelMixin 对应创建数据

        4. UpdateModelMixin 对应修改数据的时候调用

        5. DestroyModelMixin 对应删除数据的时候调用






5. 组合构建view的思路解析

    1. APIView

        1. 里面实现了很多基础的方法,比如我们可以通过APIView
        去截获 get post方法，去限制访问速度,限制用户权限

        &gt; 参看 mytest.view_test1.py

        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"> class ListUsersV2(APIView):</span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

        &gt; 参看 APIView的源码

        2. 比如我们需要获取User表里面的部分数据,我们会怎么办

        练习: 自己实现一个通过get,post,put,delete等方法访问,获取用户不同的字段信息,
        或者返回不同的值,表示了你访问了不同的方法

        答案: mytest.view_test3.py
        
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from rest_framework.views import APIView</span><br><span class="line">from django.contrib.auth.models import User</span><br><span class="line">from rest_framework.response import Response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class ListUsersV2(APIView):</span><br><span class="line"></span><br><span class="line">    def get(self, request, format&#x3D;None):</span><br><span class="line">        return Response([i.username for i in User.objects.all()])</span><br><span class="line"></span><br></pre></td></tr></table></figure>

        3. 使用get方法获取用户数据 username,email,password, 并且是key:value的形式
        答案: mytest.view_test3.py
        
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class ListUsersTest3V2Serializer(serializers.Serializer):</span><br><span class="line">    username &#x3D; serializers.CharField(max_length&#x3D;100)</span><br><span class="line">    email &#x3D; serializers.EmailField()</span><br><span class="line">    password &#x3D; serializers.CharField(max_length&#x3D;100)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class ListUsersTest3V2(APIView):</span><br><span class="line"></span><br><span class="line">    def get(self, request, format&#x3D;None):</span><br><span class="line">        # datas &#x3D; []</span><br><span class="line">        # for i in User.objects.all():</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        datas &#x3D; ListUsersTest3V2Serializer(User.objects.all()[0])</span><br><span class="line">        return Response(datas.data)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
        我们可以把数据交给序列化去帮我们把数据转化成可迭代对象或者可以被json化的数据

    2. Mixin + APIView
        1. 通过上面的接口可以知道,我们可以通过APIView实现很多我们想要的功能,
        但是,很多逻辑需要我们自己去实现,比如创建一条时间,遍历一条数据。我们也需要去
        定义get post方法去识别这些方法,来判断是否是遍历数据还是添加数据.这时候 我们
        需要mixin去帮我们实现这些功能,我们就可以少些重复性的代码。

        2. 查看mixin源码 mixins.ListModelMixin 我们可以看到他有一个list方法,
        方法的含义是把model里面的数据交给一个serializer 然后返回数据 这样 listMixin
        就有了遍历所有数据的功能

        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">class ListModelMixin(object):</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">List a queryset.</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">def list(self, request, *args, **kwargs):</span><br><span class="line">    queryset &#x3D; self.filter_queryset(self.get_queryset())</span><br><span class="line"></span><br><span class="line">    page &#x3D; self.paginate_queryset(queryset)</span><br><span class="line">    if page is not None:</span><br><span class="line">        serializer &#x3D; self.get_serializer(page, many&#x3D;True)</span><br><span class="line">        return self.get_paginated_response(serializer.data)</span><br><span class="line"></span><br><span class="line">    serializer &#x3D; self.get_serializer(queryset, many&#x3D;True)</span><br><span class="line">    return Response(serializer.data)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

        3.问题: 既然我们有mixin 为什么不直接继承mixin 而是需要把mixin和APIView
        结合来使用？

    3. ListAPIView其实就这个就是帮你把Mixin和apiview组合好了给你直接使用,
    还有其他很多方法 RetrieveAPIView,DestroyAPIView,RetrieveUpdateDestroyAPIView
    这些便捷的组合方法

    &gt; 我们只需要告诉他使用哪个model queryset serializer_class即可,他自动会帮我们
    完成数据遍历的功能和返回Response的工作
    
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class ListUsersTest3V3(ListAPIView):</span><br><span class="line"></span><br><span class="line">    model &#x3D; User</span><br><span class="line">    queryset &#x3D; User.objects.all()</span><br><span class="line">    serializer_class &#x3D; ListUsersTest3V2Serializer</span><br><span class="line"></span><br></pre></td></tr></table></figure>


    4. rest_framework.viewsets 更加高层的继承方法
        1. GenericAPIView 和 GenericViewSet


            1. 我们可以看到（源码） ListAPIView  viewsets 都是用了各种mixin
           来做组合，但是 他们最后用的GenericAPIView GenericViewSet却不一样。

            2. 所以问题出在 继承的不同的组合mixin 和 GenericAPIView,GenericViewSet
           我们已经了解不同的mixin会给我们带来不同的快捷使用方法
           现在问题就出在 GenericAPIView GenericViewSet

            3. 再次研究 GenericAPIView GenericViewSet我们可以看到
            GenericViewSet继承自 GenericAPIView 和ViewSetMixin，我们已经知道
            GenericAPIView的用处,那么GenericViewSet其实就是去扩展GenericAPIView,
            通过和ViewSetMixin去扩展

            4. ViewSetMixin 其实就是去改写我们的 get post等方法,让他在request.action
            里面变成 list create等等 观察下面的代码


            &gt;mytest.view_test4.py
            
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">class UserListTest4V1(generics.ListAPIView):</span><br><span class="line">    queryset &#x3D; User.objects.all()</span><br><span class="line">    serializer_class &#x3D; UserSerializer</span><br><span class="line"></span><br><span class="line">    def get_queryset(self):</span><br><span class="line">        x &#x3D; self.request.method</span><br><span class="line">        return super().get_queryset()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class UserListTest4V2(viewsets.ReadOnlyModelViewSet):</span><br><span class="line">    queryset &#x3D; User.objects.all()</span><br><span class="line">    serializer_class &#x3D; UserSerializer</span><br><span class="line"></span><br><span class="line">    def get_queryset(self):</span><br><span class="line">        x &#x3D; self.action</span><br><span class="line">        return super().get_queryset()</span><br></pre></td></tr></table></figure>

            在return上面断点 查看x的值是什么

            5. 再次查看ListAPIView源码 我们发现他的代码逻辑是重写了
            get方法 把get方法换成mixins里面的list方法
            
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class ListAPIView(mixins.ListModelMixin,</span><br><span class="line">  GenericAPIView):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    Concrete view for listing a queryset.</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    def get(self, request, *args, **kwargs):</span><br><span class="line">        return self.list(request, *args, **kwargs)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

            6. 查看viewsets中的方法,没有重写任何方法，直接继承过去,
            得益于我们的GenericViewSet把我们的方法换成了list等等,所以可以直接
            去使用

        2. viewset系列的里面的各种方法

            1. ReadOnlyModelViewSet

                只能查看单条数据或者多条数据

            2. ModelViewSet

                增删查改四种方法

6. 总结:
    1. 最基本的drf的view函数

    2. APIView 提供了权限 限速等等功能 和高级的GenericAPIView提供了必须自定义序列化
    和请求哪个数据库

    3. ListCreateAPIView等等组合的view 来实现各种常用的方法 但是他需要改写get post等等

    4.  ModelViewSet 等等更高级的组合view 他无需改写 get post方法

    5.  区分 generics里面的view 和 viewset里面的view 两者都是组合功能 都可以使用,但是后者更好
    用
</code></pre>
<h3 id="2-serializers"><a href="#2-serializers" class="headerlink" title="2. serializers"></a>2. serializers</h3><ol>
<li><p>serializers 序列化类的意义(验证数据和展示数据)</p>
<ol>
<li><p>序列化的简介:<br> 就像form表单一样,帮你生成表单和验证表单,序列化帮你验证和生成数据</p>
</li>
<li><p>序列化的意义:<br> 把我们复杂的数据库请求,请求之后得到的数据,转化成json,xml等简单的数据库格式<br> 类似于之前学到的form表单和formModel类,把我们定义复杂的表单转化成html的实际表单<br> ,这样你就不会在乎数据是怎么转化成html或者json的细节问题,只用定义好你对数据要求的<br> 格式，和需要序列化哪些数据即可</p>
</li>
</ol>
</li>
<li><p>外部使用django:</p>
<ol>
<li><p>django平时使用它的的功能把一些数据存入数据库,我们需要启动django的server(runserver),</p>
<pre><code> 定义view然后做路由,然后定义url，访问url,django才会执行view里面的
 相应的函数,试想一下,如果我们直接去执行一个定义好的文件去存入数据,肯定会报错

 见 mytest.test1.py
</code></pre>
</li>
<li><p>但是我们也可以在不启动django server的情况下,启动django的api,比如刚才的存入数据，我们只需要</p>
<pre><code> 在代码的运行环境中去设置django的目录,django的配置（settings.py）的位置接口,我们可以
 解决这个报错,也就可以从外部去启动django

 见 mytest.test2.py
</code></pre>
</li>
</ol>
</li>
<li><p>如何把对象序列化</p>
<blockquote>
<p>mytest.tests.py  在下面的代码中 创建一个对象 然后把对象交给序列化去处理</p>
</blockquote>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from django.test import TestCase</span><br><span class="line"></span><br><span class="line"># Create your tests here.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    import sys, os</span><br><span class="line"></span><br><span class="line">    base_dir &#x3D; os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line">    sys.path.append(base_dir)</span><br><span class="line">    os.environ[&#39;DJANGO_SETTINGS_MODULE&#39;] &#x3D; &#39;drf_movie_rimi.settings&#39;</span><br><span class="line"></span><br><span class="line">    from datetime import datetime</span><br><span class="line">    from rest_framework import serializers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    class Comment(object):</span><br><span class="line">        def __init__(self, email, content, created&#x3D;None):</span><br><span class="line">            self.email &#x3D; email</span><br><span class="line">            self.content &#x3D; content</span><br><span class="line">            self.created &#x3D; created or datetime.now()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    comment &#x3D; Comment(email&#x3D;&#39;leila@example.com&#39;, content&#x3D;&#39;foo bar&#39;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    class CommentSerializer(serializers.Serializer):</span><br><span class="line">        email &#x3D; serializers.EmailField()</span><br><span class="line">        content &#x3D; serializers.CharField(max_length&#x3D;200)</span><br><span class="line">        created &#x3D; serializers.DateTimeField()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    serializer &#x3D; CommentSerializer(comment)</span><br><span class="line">    print(serializer.data)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<pre><code>  &gt;mytest.tests.py
 使用serializer可以帮我们验证错误的数据
</code></pre>
</li>
</ol>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">comment_error &#x3D; Comment(email&#x3D;&#39;leila@example.com&#39;, content&#x3D;&#39;foo bar&#39;)</span><br><span class="line">serializer_error &#x3D; CommentSerializer(data&#x3D;comment_error)</span><br><span class="line">print(serializer_error.is_valid())</span><br><span class="line">print(serializer_error.errors)</span><br></pre></td></tr></table></figure>
</code></pre>
<ol start="4">
<li><p>序列化详解</p>
<ol>
<li><p>serializers.Serializer 最基础的序列化类</p>
<ol>
<li><p>需要我们像form 一样自己去定义每个字段的要求</p>
<blockquote>
<p>mytest.tests.py</p>
</blockquote>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class CommentSerializer(serializers.Serializer):</span><br><span class="line">    email &#x3D; serializers.EmailField()</span><br><span class="line">    content &#x3D; serializers.CharField(max_length&#x3D;200)</span><br><span class="line">    created &#x3D; serializers.DateTimeField()</span><br></pre></td></tr></table></figure></li>
<li><p>序列化后的数据，只会包含我们定义的数据，注意,就像form一样,不管我们的原始<br> 数据里面有好多数据,序列化出来的也只有我们定义的时候的那么多字段，注意我们的                对象<br> 有test=5但是序列化后的数据是没有test字段的</p>
<blockquote>
<p>mytest.tests.py</p>
</blockquote>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">	        </span><br><span class="line">class Comment(object):</span><br><span class="line">    def __init__(self, email, content, created&#x3D;None):</span><br><span class="line">        self.email &#x3D; email</span><br><span class="line">        self.content &#x3D; content</span><br><span class="line">        self.test &#x3D; &#39;5&#39;</span><br><span class="line">        self.created &#x3D; created or datetime.now()</span><br><span class="line">	        </span><br><span class="line">	        </span><br><span class="line"># 实例化一个对象 给予邮箱和内容</span><br><span class="line">comment &#x3D; Comment(email&#x3D;&#39;leila@example.com&#39;, content&#x3D;&#39;foo bar&#39;)</span><br><span class="line">	        </span><br><span class="line">	        </span><br><span class="line"># 定义序列化的数据要求</span><br><span class="line">class CommentSerializer(serializers.Serializer):</span><br><span class="line">    email &#x3D; serializers.EmailField()</span><br><span class="line">    content &#x3D; serializers.CharField(max_length&#x3D;200)</span><br><span class="line">    created &#x3D; serializers.DateTimeField()</span><br><span class="line">	</span><br></pre></td></tr></table></figure></li>
<li><p>序列化类可以帮我们验证数据是否满足我们定义的要求,就像form验证数据一样</p>
<ol>
<li>我们新建一个对象</li>
<li>把对象进行序列化成dict</li>
<li>把序列化后的数据(dict)交给序列化类检查(注意使用data)</li>
<li>验证后 可以使用is_valid查看是否验证成功</li>
<li>errors可以查看验证失败的信息</li>
<li>验证成功后可以通过validated_data来查看验证成功后的数据</li>
</ol>
<h5 id="注意-他只能验证-dict的数据-而且调用方法也不一样"><a href="#注意-他只能验证-dict的数据-而且调用方法也不一样" class="headerlink" title="注意:他只能验证 dict的数据 而且调用方法也不一样"></a>注意:他只能验证 dict的数据 而且调用方法也不一样</h5><blockquote>
<p>mytest.tests.py</p>
</blockquote>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">comment_error &#x3D; Comment(email&#x3D;&#39;leie@mple.com&#39;, content&#x3D;&#39;foo bar&#39;)</span><br><span class="line">comment_data &#x3D; CommentSerializer(comment_error)</span><br><span class="line">serializer_error &#x3D; CommentSerializer(data&#x3D;comment_data.data)</span><br><span class="line">print(serializer_error.is_valid())</span><br><span class="line">print(serializer_error.errors)</span><br><span class="line">print(serializer_error.validated_data)</span><br><span class="line">  </span><br></pre></td></tr></table></figure></li>
<li><p>我们可以把序列化后的dict转化为json数据格式</p>
<pre><code>   &gt;mytest.tests.py
     
     
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> 		...</span><br><span class="line"> 		from rest_framework.renderers import JSONRenderer</span><br><span class="line">json &#x3D; JSONRenderer().render(comment_data.data)</span><br><span class="line">print(json)</span><br><span class="line"> </span><br></pre></td></tr></table></figure>
 
</code></pre>
<p>同样 把json转化回来成dict</p>
<pre><code>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">       ...</span><br><span class="line">       </span><br><span class="line">       from django.utils.six import BytesIO</span><br><span class="line">from rest_framework.parsers import JSONParser</span><br><span class="line">					</span><br><span class="line">stream &#x3D; BytesIO(json)</span><br><span class="line">data &#x3D; JSONParser().parse(stream)</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
 
</code></pre>
</li>
</ol>
</li>
<li><p>serializer 自带数据的存储功能,我们可以定义创建数据或者修改数据的的时候去数据库保存数据</p>
<ol>
<li><p>serializer 带有save 方法,调用save方法可以调用他的create和update方法,<br>在create方法中我们可以去添加自己的逻辑,比如保存数据。</p>
</li>
<li><p>保存数据 我们需要定义create方法 让他在调用save的时候的保存数据</p>
<blockquote>
<p>mytest.serializer_test1.py</p>
</blockquote>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">   # 外部启动django的方法</span><br><span class="line">   import sys, os</span><br><span class="line">   from django.core.wsgi import get_wsgi_application</span><br><span class="line">			</span><br><span class="line">   base_dir &#x3D; os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line">   sys.path.append(base_dir)</span><br><span class="line">   os.environ[&#39;DJANGO_SETTINGS_MODULE&#39;] &#x3D; &#39;drf_movie_rimi.settings&#39;</span><br><span class="line">   application &#x3D; get_wsgi_application()</span><br><span class="line">			</span><br><span class="line">   from rest_framework import serializers</span><br><span class="line">   from mytest.models import Mytest</span><br><span class="line">			</span><br><span class="line">   class MyTestSerializer(serializers.Serializer):</span><br><span class="line">       name &#x3D; serializers.CharField(max_length&#x3D;20)</span><br><span class="line">       age &#x3D; serializers.IntegerField()</span><br><span class="line">       id &#x3D; serializers.IntegerField()</span><br><span class="line">			</span><br><span class="line">       #重写save方法 让他验证成功后保存数据</span><br><span class="line">       def create(self, validated_data):</span><br><span class="line">           return Mytest.objects.create(**validated_data)</span><br><span class="line">			</span><br><span class="line">...</span><br><span class="line">			</span><br><span class="line">			</span><br><span class="line">   serializer_data &#x3D; MyTestSerializer(data&#x3D;&#123;&#39;name&#39;:&#39;测试&#39;,&#39;age&#39;:81&#125;)</span><br><span class="line">   #必须调用了is_valid之后才能调用save方法</span><br><span class="line">   serializer_data.is_valid()</span><br><span class="line">   serializer_data.save()</span><br><span class="line">	</span><br><span class="line">  </span><br></pre></td></tr></table></figure></li>
<li><p>重写update方法 在调用 CommentSerializer(comment, data=data)后再调用save方法 他会去执行我们update函数</p>
<blockquote>
<p>mytest.serializer_test1.py</p>
</blockquote>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">      class MyTestSerializer2(serializers.Serializer):</span><br><span class="line">    name &#x3D; serializers.CharField(max_length&#x3D;20)</span><br><span class="line">    age &#x3D; serializers.IntegerField()</span><br><span class="line">    id &#x3D; serializers.IntegerField()</span><br><span class="line">			</span><br><span class="line">    # 重写update方法 让他验证成功后更新数据</span><br><span class="line">    def update(self, instance, validated_data):</span><br><span class="line">        id &#x3D; validated_data.get(&#39;id&#39;)</span><br><span class="line">        #获取manager</span><br><span class="line">        obj &#x3D; instance.objects.filter(pk&#x3D;id)[0]</span><br><span class="line">        #更新数据</span><br><span class="line">        obj.name &#x3D; validated_data.get(&#39;name&#39;, obj.name)</span><br><span class="line">        obj.age &#x3D; validated_data.get(&#39;age&#39;, obj.age)</span><br><span class="line">        try:</span><br><span class="line">            #保存更新</span><br><span class="line">            obj.save()</span><br><span class="line">        except Exception as e:</span><br><span class="line">            x &#x3D; e</span><br><span class="line">            pass</span><br><span class="line">			</span><br><span class="line">        return obj</span><br><span class="line">			</span><br><span class="line">			</span><br><span class="line">data &#x3D; Mytest.objects.all()[0]</span><br><span class="line">serializer_data &#x3D; MyTestSerializer2(Mytest, data&#x3D;&#123;&#39;id&#39;:4,&#39;name&#39;: &#39;测试&#39;, &#39;age&#39;: 81&#125;)</span><br><span class="line"># 必须调用了is_valid之后才能调用save方法</span><br><span class="line">serializer_data.is_valid()</span><br><span class="line">serializer_data.save()</span><br><span class="line">  </span><br></pre></td></tr></table></figure></li>
<li><p>梳理:</p>
<ol>
<li><p>创建数据 serializer_data = MyTestSerializer(data={‘name’:’测试’,’age’:81})后save是调用create方法</p>
</li>
<li><p>更新数据 serializer_data = MyTestSerializer2(Mytest, data={‘id’:4,’name’: ‘测试’, ‘age’: 81}) 由于没有指定更新到哪个model 所以我们需要把Model传递给我们的MyTestSerializer2</p>
</li>
</ol>
</li>
</ol>
</li>
<li><p>ModelSerializer </p>
<ol>
<li><p>简介 ModelSerializer 类似于我们的formModel类，你需要给定一个数据库的,他会自动的帮你生成验证规则。然后你给定要验证哪些字段(field)就可以了</p>
</li>
<li><p>model serializer中也自带了create和update的方法,我们验证了数据之后可以直接存入数据库(因为我们已经给定了model)</p>
</li>
<li><p>ModelSerializer相当于我们基础serializer的升级版,帮我们简化了很多操作</p>
</li>
<li><p>使用示例</p>
<blockquote>
<p>mytest.serializer_test2.py</p>
</blockquote>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">     </span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">  # 外部启动django的方法</span><br><span class="line">  import sys, os</span><br><span class="line">  from django.core.wsgi import get_wsgi_application</span><br><span class="line">		</span><br><span class="line">  base_dir &#x3D; os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line">  sys.path.append(base_dir)</span><br><span class="line">  os.environ[&#39;DJANGO_SETTINGS_MODULE&#39;] &#x3D; &#39;drf_movie_rimi.settings&#39;</span><br><span class="line">  application &#x3D; get_wsgi_application()</span><br><span class="line">		</span><br><span class="line">  from rest_framework import serializers</span><br><span class="line">  from mytest.models import Mytest</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">  class MyTestSerializer(serializers.ModelSerializer):</span><br><span class="line">      class Meta:</span><br><span class="line">          model &#x3D; Mytest</span><br><span class="line">          fields &#x3D; (&quot;name&quot;, &#39;age&#39;)</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">  data &#x3D; MyTestSerializer(data&#x3D;&#123;&#39;name&#39;: &#39;model&#39;, &#39;age&#39;: 54&#125;)</span><br><span class="line">  data.is_valid()</span><br><span class="line">  data.save()</span><br><span class="line">     </span><br><span class="line">    </span><br></pre></td></tr></table></figure></li>
<li><p>扩展方法:</p>
<ol>
<li>fields : <ol start="2">
<li>’“__all__”‘ 代表所有的字段</li>
<li>exclude = (‘users’,) 代表除了 user字段 其他字段都可以</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li><p>综合使用示例:</p>
<blockquote>
<p>mytest.test1_views.py</p>
</blockquote>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class BookListV2ViewSet(mixins.DestroyModelMixin,mixins.ListModelMixin,mixins.UpdateModelMixin,</span><br><span class="line">						mixins.RetrieveModelMixin,GenericViewSet):</span><br><span class="line">    queryset &#x3D; Book.objects.all()</span><br><span class="line">    serializer_class &#x3D; BookListSerializer</span><br><span class="line"></span><br><span class="line">    def get_queryset(self):</span><br><span class="line"></span><br><span class="line">        method &#x3D; self.request.method</span><br><span class="line"></span><br><span class="line">        x &#x3D; self.action</span><br><span class="line">        return Book.objects.all()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">实现一个方法:放里面有书,</span><br><span class="line">1.随便哪个用户可以去创建一本书</span><br><span class="line">2.只有创建这本书的用户可以去修改这本书</span><br><span class="line">3.只有创建这本书的用户可以去删除这本书</span><br><span class="line">4.所有用户可以看到所有的书</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">class BookSerializer(serializers.ModelSerializer):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        model &#x3D; Book</span><br><span class="line">        fields &#x3D; &quot;__all__&quot;</span><br><span class="line"></span><br><span class="line">    def create(self, validated_data):</span><br><span class="line">        validated_data[&#39;creator&#39;] &#x3D; self.context[&#39;request&#39;]._user</span><br><span class="line">        validated_data[&#39;name&#39;] &#x3D; &#39;不好意思&#39;</span><br><span class="line"></span><br><span class="line">        return super().create(validated_data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    def update(self, instance, validated_data):</span><br><span class="line"></span><br><span class="line">        if self.context[&#39;request&#39;]._user !&#x3D; instance.creator:</span><br><span class="line">            raise serializers.ValidationError(&#39;不是创建者&#39;)</span><br><span class="line">        return super().update(instance,validated_data)</span><br><span class="line">	</span><br><span class="line">	</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="3-url-路由表定义"><a href="#3-url-路由表定义" class="headerlink" title="3. url 路由表定义"></a>3. url 路由表定义</h3><p>1.router.register() 只有继承了viewset的类才能使用</p>
<h1 id="项目"><a href="#项目" class="headerlink" title="项目"></a>项目</h1><h3 id="1-项目简介"><a href="#1-项目简介" class="headerlink" title="1. 项目简介"></a>1. 项目简介</h3><ol>
<li><p>下载猫眼电影 高仿猫眼电影app</p>
</li>
<li><p>restful的风格的基本概念</p>
<ol>
<li>api接口开发模式</li>
</ol>
<p> 后台服务器只提供数据接口和返回数据,由前端js负责获取数据。然后动态的展现在前端。</p>
<p> 前后分离的好处–&gt;后端只负责逻辑接口和数据,前端只负责页面展现逻辑。前后端工作进度<br> 互不干扰</p>
<p> 现在主流的开发模式基本都是前后分离</p>
<ol start="2">
<li><p>restful基本概念</p>
<ol>
<li>一切的url代表的是资源,api通过get post del等动作去操控资源</li>
</ol>
<p> restful的目的在于统一化清晰化url的,一个大型网站有很多不同的url,使用restful之后可以很好的管理资源</p>
<p> 相关资料</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2014/05/restful_api.html">http://www.ruanyifeng.com/blog/2014/05/restful_api.html</a></p>
</blockquote>
<blockquote>
<p> <a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2011/09/restful.html">http://www.ruanyifeng.com/blog/2011/09/restful.html</a></p>
</blockquote>
<ol start="2">
<li>restful只是一套url设计理念,具体还是需要自己去实现</li>
</ol>
</li>
<li><p>再次查看接口文档</p>
<ol>
<li><p>create 创建一个实例 post方法</p>
</li>
<li><p>list 获取多个实例 get方法</p>
</li>
<li><p>read 方法 获取指定的实例</p>
</li>
<li><p>update partial_update更新 put PATCH</p>
</li>
<li><p>delete 销毁一个实例 delete</p>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="2-项目登录"><a href="#2-项目登录" class="headerlink" title="2.项目登录"></a>2.项目登录</h3><ol>
<li><p>新建用户model</p>
<ol>
<li><p>分析:</p>
<ol>
<li>我们知道 django自带的用户系统里面有很多可以用的数据,比如email 是否激活等等,但是还有其他信息需要我们自己去定义,比如手机 生日 昵称 地址 用户头像</li>
</ol>
</li>
<li><p>创建app和user的model</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">startapp users</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建用户模型</p>
</li>
</ol>
<blockquote>
<p>users.model.py</p>
</blockquote>
<pre><code> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">     from django.db import models</span><br><span class="line">from django.contrib.auth.models import AbstractUser</span><br><span class="line">		</span><br><span class="line"># Create your models here.</span><br><span class="line"></span><br><span class="line">class UserProfile(AbstractUser):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    用户信息</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    IS_VIP &#x3D; (</span><br><span class="line">        (False, &#39;非会员&#39;),</span><br><span class="line">        (True, &#39;会员&#39;)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    GENDER &#x3D; (</span><br><span class="line">        (&quot;male&quot;, &quot;男&quot;),</span><br><span class="line">        (&quot;female&quot;, &quot;女&quot;)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    nick_name &#x3D; models.CharField(default&#x3D;&quot;&quot;, max_length&#x3D;50, verbose_name&#x3D;&quot;昵称&quot;, null&#x3D;True, </span><br><span class="line">    								blank&#x3D;True)</span><br><span class="line">    birthday &#x3D; models.DateTimeField(verbose_name&#x3D;&quot;生日&quot;, null&#x3D;True, blank&#x3D;True, </span><br><span class="line">    						auto_created&#x3D;True)</span><br><span class="line">    gender &#x3D; models.CharField(max_length&#x3D;1, choices&#x3D;((&quot;1&quot;, &quot;男&quot;), (&quot;2&quot;, &quot;女&quot;)), default&#x3D;&quot;1&quot;, </span><br><span class="line">    						null&#x3D;True,blank&#x3D;True)</span><br><span class="line">    address &#x3D; models.CharField(max_length&#x3D;100, default&#x3D;&quot;&quot;, verbose_name&#x3D;&#39;用户所在城市&#39;, </span><br><span class="line">    						null&#x3D;True, blank&#x3D;True)</span><br><span class="line">    mobile &#x3D; models.CharField(max_length&#x3D;14, default&#x3D;&quot;&quot;, verbose_name&#x3D;&#39;手机号&#39;)</span><br><span class="line">    register_time &#x3D; models.DateTimeField(auto_now&#x3D;True)</span><br><span class="line">    </span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name &#x3D; &quot;用户信息&quot;</span><br><span class="line">        verbose_name_plural &#x3D; verbose_name</span><br><span class="line"></span><br><span class="line">    def __str__(self):</span><br><span class="line">        return str(self.mobile)</span><br><span class="line">     </span><br><span class="line">     </span><br></pre></td></tr></table></figure>
</code></pre>
<blockquote>
<p>settings.py</p>
</blockquote>
<pre><code> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  ...</span><br><span class="line">  AUTH_USER_MODEL &#x3D; &quot;users.UserProfile&quot;</span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  INSTALLED_APPS &#x3D; [</span><br><span class="line">		...</span><br><span class="line">    &#39;users.apps.UsersConfig&#39;</span><br><span class="line">]</span><br><span class="line"> </span><br></pre></td></tr></table></figure>
 
  注释掉settings.py里面的 &#39;django.contrib.admin&#39;, 这一行
 
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">makemigrations</span><br><span class="line">migrate</span><br></pre></td></tr></table></figure>
 

  打开注释掉settings.py里面的 &#39;django.contrib.admin&#39;, 这一行
  
</code></pre>
<ol start="4">
<li><p>知识点:</p>
<ol>
<li> 扩展django已经有的user需要去继承django本身的用户模型表</li>
</ol>
<blockquote>
<p>users.model.py</p>
</blockquote>
<pre><code> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">     </span><br><span class="line">       from django.contrib.auth.models import AbstractUser</span><br><span class="line">			</span><br><span class="line">			</span><br><span class="line"># Create your models here.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class UserProfile(AbstractUser):</span><br><span class="line">...</span><br><span class="line">     </span><br></pre></td></tr></table></figure>
</code></pre>
<ol start="2">
<li><p>在字段信息中新建 choices 参数,表示字段里面的只能是choices里面元组的几个值之一,tuple里面的第一个值是数据库里面值,第二个是备注,比如 数据库里面存 1 表示男 2表示女</p>
<blockquote>
<p>users.model.py</p>
</blockquote>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">     ...</span><br><span class="line">     </span><br><span class="line">       GENDER &#x3D; (</span><br><span class="line">    (&quot;1&quot;, &quot;男&quot;),</span><br><span class="line">    (&quot;2&quot;, &quot;女&quot;)</span><br><span class="line">)</span><br><span class="line">				</span><br><span class="line">nick_name &#x3D; models.CharField(default&#x3D;&quot;&quot;, max_length&#x3D;50, verbose_name&#x3D;&quot;昵称&quot;, </span><br><span class="line">							null&#x3D;True, blank&#x3D;True)</span><br><span class="line">birthday &#x3D; models.DateTimeField(verbose_name&#x3D;&quot;生日&quot;, null&#x3D;True, </span><br><span class="line">							blank&#x3D;True, auto_created&#x3D;True)</span><br><span class="line">gender &#x3D; models.CharField(max_length&#x3D;1, choices&#x3D;GENDER, default&#x3D;&quot;1&quot;, null&#x3D;True,</span><br><span class="line">     </span><br><span class="line">     ...</span><br><span class="line"> </span><br></pre></td></tr></table></figure></li>
<li><p>参数 null=True , blank=True分别表示数据里面可以存null这个值,和数据库里面可以存空值,记住 null 和空值是不一样的</p>
</li>
<li><p>参数 auto_now auto_now_add 表示添加数据的时候默认添加当前时间,以后不会自动修改; 修改数据的时候默认添加当前时间,每次修改都会自动变化</p>
</li>
<li><p>class Meta: 里面的verbose_name 表示amdin查看这个表的时候 会出现你输入的表名</p>
</li>
<li><p>def <strong>str</strong>(self） 表示查看数据的时候(admin中),每一条数据会返回你定制化的标题,比如我们这个表就会返回一系列的手机号</p>
</li>
<li><p>字段里面加入unique表示我们不能重复！             </p>
<blockquote>
<ol>
<li>但是这个unique会造成我们的一个困境,如果是注册手机号的话,我们每次新建用户就必须输入不同的手机号,你不能不输入,但是如果我们是用户名和邮箱注册的话,那么我们在注册的时候是不会用到手机号。</li>
</ol>
</blockquote>
</li>
</ol>
<blockquote>
<ol start="2">
<li>解决方案是给他设置null=True,defalut=None</li>
<li>解决方案的原理是计算机中有一个null|None表示(无),这个在这个计算机中是唯一的</li>
</ol>
</blockquote>
</li>
</ol>
</li>
<li><p>制作 注册 登录 注销模块</p>
<ol>
<li>JWT<ol>
<li>简介: 传统的session登录方式受限于设备和浏览器,如果我们制作的是一个app而不是使用浏览器去访问。那么我们的整个的</li>
</ol>
</li>
</ol>
<pre><code>保持用户登录就会变得很麻烦,再者 判断用户登录是否成功也不能依赖于我们的模板文件了 官网地址：
</code></pre>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://getblimp.github.io/django-rest-framework-jwt/">http://getblimp.github.io/django-rest-framework-jwt/</a></p>
</blockquote>
<pre><code>2. token: token有令牌的意思,他类似以于我们的session，是一串加密数字。我们可以把它理解为session的升级版,因为token更灵活,他可以用于手机app 网页任何地方
 
3. JWT: JWT-&gt; json web token 是token的一个json实现标准,你可以理解为一般互联网企业都是这样做的。所以我们也拿来用即可。JWT最明显的特征是 JWT不会存在于数据库，它类似于csrf_token，我们只用去验证加密是否通过,通过之后就是合法的用户。
</code></pre>
</li>
</ol>
<pre><code>      4. 安装

          <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install djangorestframework-jwt</span><br></pre></td></tr></table></figure>

          在配置文件里面加入,下面这行代码的意思是使用token来认证用户身份

          &gt;settings.py

          <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  ...</span><br><span class="line">  REST_FRAMEWORK &#x3D; &#123;</span><br><span class="line">    # Use Django&#39;s standard &#96;django.contrib.auth&#96; permissions,</span><br><span class="line">    # or allow read-only access for unauthenticated users.</span><br><span class="line">    # &#39;DEFAULT_PERMISSION_CLASSES&#39;: [</span><br><span class="line">    #     &#39;rest_framework.permissions.DjangoModelPermissionsOrAnonReadOnly&#39;</span><br><span class="line">    # ]</span><br><span class="line"></span><br><span class="line">    &#39;DEFAULT_AUTHENTICATION_CLASSES&#39;: (</span><br><span class="line">        &#39;rest_framework_jwt.authentication.JSONWebTokenAuthentication&#39;,</span><br><span class="line">    ),</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

          &gt;urls.py

          <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">from rest_framework_jwt.views import obtain_jwt_token</span><br><span class="line">  #...</span><br><span class="line"></span><br><span class="line">  urlpatterns &#x3D; [</span><br><span class="line">      &#39;&#39;,</span><br><span class="line">      # ...</span><br><span class="line"></span><br><span class="line">      url(r&#39;^api-token-auth&#x2F;&#39;, obtain_jwt_token),</span><br><span class="line">  ]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      5. 访问 /docs/接口，就可以看到登录的界面(文档自动生成)

      6. 试着登录 就可以看到返回,这个就是我们的登录秘钥,拿着这个秘钥就可以去验证
      用户信息

      <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> &#123;</span><br><span class="line">&quot;token&quot;: &quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxLCJ1c2VybmFtZSI6ImNhbnZhcyIsImV4cCI6MTUzMjAwODg5OSwiZW1haWwiOiIyQDIuY29tIn0.mVhVHMIZZ2qqhzBen7kS8csylx7yrif1gQhw-09wcus&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
      7. 我们把token取出来,在postman上面添加上我们的token
          1. 在post man headers里面去添加一个 key 为 Authorization
          value为 JWT（空格） eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxLCJ1c2VybmFtZSI6ImNhbnZhcyIsImV4cCI6MTUzMjAwODg5OSwiZW1haWwiOiIyQDIuY29tIn0.mVhVHMIZZ2qqhzBen7kS8csylx7yrif1gQhw-09wcus
      
      8. 在我们的views里面去配置用户认证
      
          <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">from rest_framework_jwt.authentication import JSONWebTokenAuthentication</span><br><span class="line">class xxxView()</span><br><span class="line">...</span><br><span class="line">	authentication_classes &#x3D; (JSONWebTokenAuthentication,)</span><br></pre></td></tr></table></figure>
          
      9. 再访问我们的接口看看是不是把用户取出来了

      10. JWT配置:
    
        设置token的过期时间JWT_EXPIRATION_DELTA
        
      <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">      </span><br><span class="line">       JWT_AUTH &#x3D; &#123;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">   &#39;JWT_EXPIRATION_DELTA&#39;: datetime.timedelta(seconds&#x3D;3600),</span><br><span class="line">			</span><br><span class="line">			</span><br><span class="line">&#125;</span><br><span class="line">      </span><br></pre></td></tr></table></figure>
          
     
      
  2. 利用JWT做登录接口
      
      1. 我们可以从后台新建用户,所以我们可以先做登录,上面我们看到 JWT 登录成功之后返回的是一串token,所以我们登录的任务就是验证数据库账户密码,然后返回一串token给前端。前端以后的请求每次都会带上这个token来,关于前端具体情况我们不用关心。
      
      2. 所以我们的问题流程就分解为
      
          1. 接收用户传递过来的账户密码
          2. 验证账户密码
          3. 验证成功返回token(这里就不用去调用login 接口了 因为我们不用session去做登录) 
          
      3. 根据上面的问题流程我们的代码聚体步骤就分为:
          1. 通过一个view去接收参数,这个view不需要多余的功能,也不会创建遍历数据,只是接收和返回值，所以我们选用 APIView来做view


          2. 我们需要一个函数去验证用户名和密码,这个函数我们已经知道,django的auth接口
          3. 我们在最后需要一个东西去加密用户信息成为标准token,然后返回给前端,我们需要jwt的标准接口 查看官网 
          
          http://getblimp.github.io/django-rest-framework-jwt/
          
          我们可以看到最后官网给了我们标准的token加密方法,代码指出,我们给定用户,然后交给他的用户,他就会给出token,然后我们把token返回给前段即可
          
              <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">      </span><br><span class="line">       from rest_framework_jwt.settings import api_settings</span><br><span class="line">		</span><br><span class="line">jwt_payload_handler &#x3D; api_settings.JWT_PAYLOAD_HANDLER</span><br><span class="line">jwt_encode_handler &#x3D; api_settings.JWT_ENCODE_HANDLER</span><br><span class="line"></span><br><span class="line">payload &#x3D; jwt_payload_handler(user)</span><br><span class="line">token &#x3D; jwt_encode_handler(payload）</span><br></pre></td></tr></table></figure>
              
          4. 根据以上思想形成真实代码示例:
           
           &gt; users.views.py
           
                   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">       </span><br><span class="line">          from rest_framework.views import APIView</span><br><span class="line">from rest_framework_jwt.settings import api_settings</span><br><span class="line">from rest_framework.response import Response</span><br><span class="line">from django.contrib.auth import authenticate</span><br><span class="line">from .serializers import UserLoginSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class UserLogin(APIView):</span><br><span class="line">    def post(self, request):</span><br><span class="line"></span><br><span class="line">        datas &#x3D; UserLoginSerializer(data&#x3D;request.POST)</span><br><span class="line">        if datas.is_valid():</span><br><span class="line">            user &#x3D; authenticate(**datas.validated_data)</span><br><span class="line">            if user:</span><br><span class="line">                jwt_payload_handler &#x3D; api_settings.JWT_PAYLOAD_HANDLER</span><br><span class="line">                jwt_encode_handler &#x3D; api_settings.JWT_ENCODE_HANDLER</span><br><span class="line"></span><br><span class="line">                payload &#x3D; jwt_payload_handler(user)</span><br><span class="line">                token &#x3D; jwt_encode_handler(payload)</span><br><span class="line">                return Response(token)</span><br><span class="line"></span><br><span class="line">        return Response(status&#x3D;401)</span><br><span class="line">	</span><br><span class="line">       </span><br></pre></td></tr></table></figure>
                   
               &gt; users.serializers.py
               
               <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">     </span><br><span class="line">     from rest_framework import serializers</span><br><span class="line"></span><br><span class="line">class UserLoginSerializer(serializers.Serializer):</span><br><span class="line">    username &#x3D; serializers.CharField(max_length&#x3D;20,help_text&#x3D;&#39;用户名&#39;)</span><br><span class="line">    password &#x3D; serializers.CharField(max_length&#x3D;20,help_text&#x3D;&#39;密码&#39;)</span><br><span class="line">     </span><br></pre></td></tr></table></figure>
               
               
3. 利用JWT做注册接口

    1. 流程解析:
        1. 用户提交注册申请,也就是用户名密码
        2. 后端验证用户名是否存在,存在返回错误
        3. 生成用户
        4. 给生成的用户返回token 然后直接登录成功
        
    2. 代码解析:
    
        1. 接收用户的参数
        2. 验证用户名是否重复
        3. 生成用户
        4. 返回token
    
    3. 代码示例:
            &gt;users.views.py
            
           <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  class UserRegister(APIView):</span><br><span class="line"># 如果是post请求</span><br><span class="line">def post(self, request):</span><br><span class="line">    # 我们验证他的post数据,和序列化</span><br><span class="line">    datas &#x3D; UserLoginSerializer(data&#x3D;request.POST)</span><br><span class="line">    if datas.is_valid():</span><br><span class="line">        # 我们把验证成功的数据交给django验证</span><br><span class="line">        data &#x3D; datas.validated_data</span><br><span class="line">        # 获取用户model</span><br><span class="line">        User &#x3D; get_user_model()</span><br><span class="line">        # 获取用户信息</span><br><span class="line">        user &#x3D; User.objects.filter(username&#x3D;data[&#39;username&#39;])</span><br><span class="line">        # 如果有用户则不创建用户</span><br><span class="line">        if not user:</span><br><span class="line">            user &#x3D; User.objects.create_user(**data)</span><br><span class="line">            # 调用jwt官方指定的方法加密用户信息获取到token</span><br><span class="line">            jwt_payload_handler &#x3D; api_settings.JWT_PAYLOAD_HANDLER</span><br><span class="line">            jwt_encode_handler &#x3D; api_settings.JWT_ENCODE_HANDLER</span><br><span class="line">			</span><br><span class="line">            payload &#x3D; jwt_payload_handler(user)</span><br><span class="line">            token &#x3D; jwt_encode_handler(payload)</span><br><span class="line">            return Response(&#123;&#39;token&#39;: token&#125;)</span><br><span class="line">    # 如果失败,我们统一返回401表示登录不成功</span><br><span class="line">    return Response(status&#x3D;401)</span><br><span class="line">      </span><br></pre></td></tr></table></figure>
           
       还可以使用mixins去注册用户
&gt; users.views.py

        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line"># 通过mixin来创建用户</span><br><span class="line">from django.contrib.auth.hashers import make_password</span><br><span class="line">from django.contrib.auth import get_user_model</span><br><span class="line">from rest_framework import mixins</span><br><span class="line"></span><br><span class="line">User &#x3D; get_user_model()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class UserInfoSerializer(serializers.ModelSerializer):</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">略</span><br></pre></td></tr></table></figure>


           
4. 扩展注册接口
    1. 简介:我们的注册远没有那么多简单,我们需要手机注册,发送短信验证码。或者邮箱验证码之类的。然后填入验证码才能激活用户
    2. 为了防止爬虫,我们需要在下面多添加一个图形验证码。每次请求需要用户提交图形验证码系统才会执行发送短信的接口。
    3. 试想一个问题:
    
        1. 发送短信的原理其实就是我们首先去运营商那里购买短信服务,然后提交要送发的短信内容,和接收的短信的手机号。是运营商帮我们去发送短信。然后发送成功后,运营商通知我们短信发送成功。我们去通知用户。

        2. 上面那个流程有一个重大的bug,在上面的步骤中,请求运营商发送短信和等待运营商通知我们的服务器接收短信的时间是很长的。用户会一直卡在那里,程序也会一直卡在那里。如果运营商发送短信的时间很长,那么势必会卡死我们的程序线程。那么一个新开的网站,用户访问量大得时候,你是无法去承载这个网站的
        3. 这个时候,我们需要异步接口,即把发送短信请求或者发送邮箱请求的接口交给其他程序去做,我们不用理会,直接返给给用户申请成功。请求等待短信即可


        4. 画图解释
        
    4. 问题解决思路:
        1. 我们需要知道注册的具体流程:
        
            1. 首先 注册时候手机验证码是在后台生成的,然后存入数据库,但是要首先验证码账户是否存在
            2. 把这个验证码 通过一定的接口发送给用户
            3. 用户得到验证码之后,再把账户和验证码和密码一起提交,服务器收到验证码和用户名之后,对比数据库,如有符合的数据,就可以确认这个手机(收到验证码的手机)是这个用户的。
            4. 传统方式下 第一步第二步是链接在一起的
            5. 如果是异步接口,我们的程序只到第一步,第二步骤会有专门的程序去执行这个接口。
            6. 执行这个异步接口的实现方案是 队列任务,顾名思义,就是让发送验证码这个耗时的操作去让其他程序执行,如果其他程序执行不过来,那么发送验证码任务就会排队处理（在其他程序中,主程序已经结束）,但是这不会影响到用户体验,因为用户收到验证码这个时间本来就是耗时的。
            
    5. 代码思路:
        1. 接受用户账户的接口,验证账户是否已经存在
        2. 生成随机验证码的接口
        3. 请求发送验证码的接口
        4. 接受异步任务的接口
        5. 由于没有手机验证码,我们使用邮箱验证码做替代
        
    6. 基本代码实现 
    
       1. 传统的同步方式 没有图像验证码 发送接收一个邮箱,然后发送邮箱验证码,我们首先建立一个接受验证码的model 里面有邮件 验证码两个字段 外键添加时间判断验证码是否过期
       
          &gt;users.models.py
       
           <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">class CaptchaReg(models.Model):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    用户注册验证码</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    captcha &#x3D; models.CharField(max_length&#x3D;6, verbose_name&#x3D;&#39;验证码&#39;, help_text&#x3D;&#39;验证码&#39;)</span><br><span class="line">    email &#x3D; models.EmailField(verbose_name&#x3D;&#39;注册邮箱&#39;,help_text&#x3D;&#39;注册邮箱&#39;)</span><br><span class="line">    add_time &#x3D; models.DateTimeField(auto_now&#x3D;True, verbose_name&#x3D;&#39;添加时间&#39;, </span><br><span class="line">    help_text&#x3D;&#39;添加时间&#39;)</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name &#x3D; &#39;用户注册验证码&#39;</span><br><span class="line">        verbose_name_plural &#x3D; &#39;用户注册验证码&#39;</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
           
       2. 我们使用createmixins来做view 因为我们相当于去创建一条验证码的数据
       3. 我们需要在serializer中改写captcha的方式,让captcha字段自动去生成,而且不是让用户传递过来

                  
             
      4. 我们还需要创建两个函数
     
          1. 一个是生成随机验证码的

              <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">def gen_captcha():</span><br><span class="line">   captcha_str &#x3D; &quot;&quot;</span><br><span class="line">   for i in range(6):</span><br><span class="line">       captcha_str +&#x3D; str(random.randint(0, 9))</span><br><span class="line">   return captcha_str</span><br><span class="line"></span><br></pre></td></tr></table></figure>
          2. 把生成的随机验证码通过邮件发送

        5. 把生成验证码的函数放在serializer里面
            1. 知识点
                1. serializer里面的validate函数可以帮我们验证数据,并且把合法的数据传递给create函数去创建数据,由于我们没有定义captcha字段,但是又需要captcha字段去写入数据库,所以我们在validate里面取增加captcha 当然 增加的是我们函数调用的生成随机验证码
                
            
                    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">			    </span><br><span class="line">class UserRegisterCaptchaCreateSerializer(serializers.ModelSerializer):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    验证邮箱是否已经被注册了</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    def create(self, validated_data):</span><br><span class="line">        email &#x3D; validated_data[&#39;email&#39;]</span><br><span class="line">        if User.objects.filter(email&#x3D;email).exists():</span><br><span class="line">            raise serializers.ValidationError(&#39;邮箱已经存在&#39;)</span><br><span class="line"></span><br><span class="line">        return super().create(validated_data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    def validate(self, attrs):</span><br><span class="line">        captcha &#x3D; captchas.gen_captcha()</span><br><span class="line">        attrs[&#39;captcha&#39;] &#x3D; captcha</span><br><span class="line">        return super().validate(attrs)</span><br><span class="line">  </span><br><span class="line">  </span><br></pre></td></tr></table></figure>
            
    
        6. 生成一个发送通过邮件发送验证码的接口:
            1. 知识点:
            
                1. smtp邮件服务器
                
                    1. smtp邮件服务器是一种协议
                    2. 我们可以调用网易的smtp邮件接口给其他人发邮件
                    3. 其实就相当于你去登录网易邮件手写一封邮件
                    4. 不过由于你有了邮件接口,你可以在程序中配置好账户密码 然后调用程序去帮你发送验证码。效果和3差不多
                2. 邮件发送接口调用
                    1. 查看自己的邮件接口
                        1. https://mail.163.com
                        2. 查看设置 最下面有pop3 smtp imap服务
                        3. 查看网易邮件服务的端口 http://help.163.com/09/1223/14/5R7P3QI100753VB8.html
                        4. 在settings.py里面去配置

                           &gt; mytest.settings.py

                                <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">EMAIL_HOST &#x3D; &#39;smtp.163.com&#39;                   #SMTP地址</span><br><span class="line">EMAIL_PORT &#x3D; 25                                 #SMTP端口</span><br><span class="line">EMAIL_HOST_USER &#x3D; &#39;qq360167228@163.com&#39;       #我自己的邮箱</span><br><span class="line">EMAIL_HOST_PASSWORD &#x3D; &#39;rimi123&#39;                  #我的邮箱授权码</span><br><span class="line"></span><br></pre></td></tr></table></figure>

                        5. 然后我们调用邮件函数就可以去发送,函数主要需要邮件标题,邮件内容,收件人的地址三个参数

                            1. 测试版本

                                &gt; mytest.test_mail.py

                                <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    # 外部启动django的方法</span><br><span class="line">    import sys, os</span><br><span class="line">    from django.core.wsgi import get_wsgi_application</span><br><span class="line"></span><br><span class="line">    base_dir &#x3D; </span><br><span class="line">    os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line">    sys.path.append(base_dir)</span><br><span class="line">    os.environ[&#39;DJANGO_SETTINGS_MODULE&#39;] &#x3D; </span><br><span class="line">    &#39;drf_movie_rimi.settings&#39;</span><br><span class="line">    </span><br><span class="line">    application &#x3D; get_wsgi_application()</span><br><span class="line"></span><br><span class="line">    from django.core.mail import send_mail</span><br><span class="line"></span><br><span class="line">    x &#x3D; send_mail(&#39;注册验证码&#39;, &#39;Here is the message.&#39;, </span><br><span class="line">    &#39;qq360167228@163.com&#39;,[&#39;qq360167229@163.com&#39;])</span><br><span class="line"></span><br><span class="line">    print(x)</span><br></pre></td></tr></table></figure>

                            2. 正式版本:
                                
                                &gt;utils.send_sms_email.py

                                   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">            		</span><br><span class="line">            		from django.core.mail import send_mail</span><br><span class="line">from drf_movie_rimi.settings import EMAIL_HOST_USER</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def my_send_mail(title, context, to_mail):</span><br><span class="line">    # 三个参数为 发送标题 内容 收件人</span><br><span class="line">    res &#x3D; send_mail(title, context, EMAIL_HOST_USER,</span><br><span class="line">                    [to_mail])</span><br><span class="line"></span><br><span class="line">    return bool(res)</span><br><span class="line"></span><br><span class="line">            		</span><br><span class="line">            		</span><br></pre></td></tr></table></figure>

                3. django注册发送验证码的流程

                    1. 知识点:
                    
                        1. 我们需要在整体流程的最后一步 也就是先发送验证码,发送验证码成功后,存储验证码到数据库,然后返回给用户发送成功信息。所以我们需要改写views里面的最后一步 perform_create 在这一步里面,views会存储合法数据到数据库。
                        2. 改写 serializers.py里面的validate 函数,由于我们只提供了email参数,所以我们必须把验证码(captcha加入进去)
                        3. 知识点梳理 

                            perform_create是createmixin里面的方法。他是在最后存储数据的时候调用
                            
                            validate 是serializer里面的方法,他控制了所有有效数据的,我们可以在这里面去改写有效数据
                        
                 
                    
                               
                    &gt;users.views.py
                    
                    
                    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">...		</span><br><span class="line"></span><br><span class="line">class UserRegisterCaptchaCreateViewSet(CreateModelMixin, GenericViewSet):</span><br><span class="line">    queryset &#x3D; UserRegisterCaptchaCreateSerializer.Meta.model.objects.all()</span><br><span class="line">    serializer_class &#x3D; UserRegisterCaptchaCreateSerializer</span><br><span class="line"></span><br><span class="line">    def perform_create(self, serializer):</span><br><span class="line">        data &#x3D; serializer.validated_data</span><br><span class="line">        captcha &#x3D; &#39;您的验证码为&#123;&#125;&#39;.format(data[&#39;captcha&#39;])</span><br><span class="line">        res &#x3D; my_send_mail(&#39;注册验证码&#39;,captcha,data[&#39;email&#39;])</span><br><span class="line">        if not res:</span><br><span class="line">            return Response(status&#x3D;401)</span><br><span class="line">        return super().perform_create(serializer)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
        
        
                    &gt;users.serializers.py
                    
                    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">class UserRegisterCaptchaCreateSerializer(serializers.ModelSerializer):</span><br><span class="line">   &quot;&quot;&quot;</span><br><span class="line">   验证邮箱是否已经被注册了</span><br><span class="line">   &quot;&quot;&quot;</span><br><span class="line">					</span><br><span class="line">    def create(self, validated_data):</span><br><span class="line">        email &#x3D; validated_data[&#39;email&#39;]</span><br><span class="line">        if User.objects.filter(email&#x3D;email).exists():</span><br><span class="line">            raise serializers.ValidationError(&#39;邮箱已经存在&#39;)</span><br><span class="line"></span><br><span class="line">        return super().create(validated_data)</span><br><span class="line"></span><br><span class="line">    def validate(self, attrs):</span><br><span class="line">        captcha &#x3D; captchas.gen_captcha()</span><br><span class="line">        attrs[&#39;captcha&#39;] &#x3D; captcha</span><br><span class="line">        return super().validate(attrs)</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        model &#x3D; CaptchaReg</span><br><span class="line">        fields &#x3D; (&#39;email&#39;,)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
                    
            4. 通过mixins去做用户注册操作的版本
                &gt;users.serializers.py
                
                <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">					#验证码升级版##############</span><br><span class="line">class UserInfoSerializer(serializers.ModelSerializer):</span><br><span class="line"></span><br><span class="line">    # 这个步骤是专门给你用的,用于你去修改已经验证好的数据,大前提是你的数据通过验证了</span><br><span class="line">    # 才去做定制化</span><br><span class="line">    def validate(self, attrs):</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line"></span><br></pre></td></tr></table></figure>
                
                &gt;users.views.py
                
                <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class UserRegisterCaptchaCreateViewSet(CreateModelMixin, GenericViewSet):</span><br><span class="line">    queryset &#x3D; UserRegisterCaptchaCreateSerializer.Meta.model.objects.all()</span><br><span class="line">    serializer_class &#x3D; UserRegisterCaptchaCreateSerializer</span><br><span class="line">  </span><br><span class="line">  ...</span><br><span class="line"></span><br></pre></td></tr></table></figure>
        
                
        7. 升级版,使用队列异步发送代码 
        
            1. [首要步骤django-celery知识点](#django-celery)
            
        8. 继续升级邮箱验证码时间的验证
            1. 问题:
                1. 我们不能让一个邮箱才发送了一个邮件就又马上又发送,一般会有一分钟的间隔
                2. 验证码拿过来也是有时效的,一般5分钟内有效
                3. 如果一个验证码验证了,那么他就失效了
            2. 流程梳理:
            
                1. 如果你一个邮件发送后,他会有发送时间，我们规定，在1分钟之后才能发送
                2. 验证邮箱验证码时,我们永远去验证最新（时间）的验证码
                3. 如果验证码发送时间距离验证的时间超过五分钟，那么他也是无效的

            3. 代码实现:
            
                &gt;users.serializers.py
                
                    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class UserRegisterCaptchaCreateSerializer(serializers.ModelSerializer):</span><br><span class="line">		</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">     #验证是否是发送验证码过于频繁</span><br><span class="line">       expire_time &#x3D; timezone.now() -</span><br><span class="line">       timezone.timedelta(minutes&#x3D;EMAIL_CAPTCHA[&#39;delay_time&#39;][&#39;register&#39;])</span><br><span class="line">					</span><br><span class="line">       if CaptchaReg.objects.filter(email&#x3D;email,add_time__gt&#x3D;expire_time).exists():</span><br><span class="line">           raise serializers.ValidationError(&#39;请稍后再发送邮件&#39;)</span><br><span class="line">					</span><br><span class="line">       return super().create(validated_data)</span><br></pre></td></tr></table></figure>
                    
                &gt;users.settins.py
                    
                    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#邮箱验证码过期时间</span><br><span class="line"></span><br><span class="line">EMAIL_CAPTCHA &#x3D; &#123;</span><br><span class="line">    &#39;expire_time&#39;:&#123;</span><br><span class="line">       &#39;register&#39;:5</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    &#39;delay_time&#39;:</span><br><span class="line">        &#123;</span><br><span class="line">            &#39;register&#39;:1</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
                    
            4. 现在 用户注册的时候,需要把邮箱验证码提交给我们,通过了才能注册
                1.我们加入验证email password username captcha的四个字段的验证码程序
                2.email和capcha要在有效时间内找到才能通过,通过后 用户基本验证成功
            
                &gt;users.views.py
                
                <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class UserRegisterV2(APIView):</span><br><span class="line">    # 如果是post请求</span><br><span class="line">    def post(self, request):</span><br><span class="line">        # 我们验证他的post数据,和序列化</span><br><span class="line">        datas &#x3D; UserLoginV2Serializer(data&#x3D;request.POST)</span><br><span class="line">        if datas.is_valid():</span><br><span class="line">            # 我们把验证成功的数据交给django验证</span><br><span class="line">            data &#x3D; datas.validated_data</span><br><span class="line">            # 获取用户model</span><br><span class="line">            User &#x3D; get_user_model()</span><br><span class="line">            # 获取用户信息</span><br><span class="line">            user &#x3D; User.objects.filter(username&#x3D;data[&#39;username&#39;])</span><br><span class="line">            # 如果有用户则不创建用户</span><br><span class="line">            if user:</span><br><span class="line">                raise serializers.ValidationError(&#39;用户名重复&#39;)</span><br><span class="line"></span><br><span class="line">            # 验证验证码码是否正确</span><br><span class="line">            expire_time &#x3D; timezone.now() - </span><br><span class="line">            timezone.timedelta(minutes&#x3D;EMAIL_CAPTCHA[&#39;expire_time&#39;][&#39;register&#39;])</span><br><span class="line"></span><br><span class="line">            if not CaptchaReg.objects.filter(email&#x3D;data[&#39;email&#39;], </span><br><span class="line">            captcha&#x3D;data[&#39;captcha&#39;],add_time__gt&#x3D;expire_time).exists():</span><br><span class="line">                raise serializers.ValidationError(&#39;邮箱错误或验证码失效&#39;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            user &#x3D; User.objects.create_user(**data)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

            
        
5. JWT 升级登录接口        
    1. 我们登录接口需要验证用户名或者邮箱然后密码 合法就登录

        代码实现，我们需要把登录的合法用户取出来,然后给JWT加密 返回token信息
               <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">		   		</span><br><span class="line">class UserLogin(APIView):</span><br><span class="line"> # 如果是post请求</span><br><span class="line"> def post(self, request):</span><br><span class="line">     # 我们验证他的post数据,和序列化</span><br><span class="line">     datas &#x3D; UserLoginSerializer(data&#x3D;request.POST)</span><br><span class="line">     if datas.is_valid():</span><br><span class="line">         # 我们把验证成功的数据交给django验证</span><br><span class="line">         user &#x3D; authenticate(**datas.validated_data)</span><br><span class="line">         if user:</span><br><span class="line">             # 调用jwt官方指定的方法加密用户信息获取到token</span><br><span class="line">             jwt_payload_handler &#x3D; api_settings.JWT_PAYLOAD_HANDLER</span><br><span class="line">             jwt_encode_handler &#x3D; api_settings.JWT_ENCODE_HANDLER</span><br><span class="line">					</span><br><span class="line">             payload &#x3D; jwt_payload_handler(user)</span><br><span class="line">             token &#x3D; jwt_encode_handler(payload)</span><br><span class="line">             return Response(&#123;&#39;token&#39;: token&#125;)</span><br><span class="line">     # 如果失败,我们统一返回401表示登录不成功</span><br><span class="line">     return Response(status&#x3D;401)</span><br><span class="line">		   		</span><br></pre></td></tr></table></figure>
               
</code></pre>
<h3 id="3-项目页面展示"><a href="#3-项目页面展示" class="headerlink" title="3.项目页面展示"></a>3.项目页面展示</h3><ol>
<li><p>项目需求分析:</p>
<ol>
<li><p>电影模型分析:</p>
<ol>
<li>首先我们需要一部影片信息的model 存储电影的信息</li>
<li>我们的电影有职员(演员 导演 编辑等等) 他们和电影是多对多</li>
<li>电影职员和类型也是对多对 比如马特达蒙 是演员 导演编辑</li>
<li>电影有所属国家 是多对多关系</li>
<li>电影有制作类型,比如2D, 3D等等 他和电影是对多对关系</li>
<li>电影有分类,比如动作,悬疑,科幻 他和电影是多对多关系</li>
</ol>
</li>
<li><p>影院模型分析:</p>
<ol>
<li>我们购买电影会细化到某个影院,某个座位,某个时间的电影</li>
<li>我们需要影院</li>
<li>我们的影院里面有很多影厅,他和影院是一对多关系</li>
<li>影厅中很多座位,他和影厅是一对多关系</li>
<li>我们电影有很多的片场,每个片场必须有一个影厅,他和影厅是一对多关系</li>
<li>影院有所属城市,他和影院是一对多关系</li>
</ol>
</li>
<li><p>根据上面的分析 我们的模型设计如下</p>
<pre><code> &gt;movie.model.py
</code></pre>
<p> 知识点:</p>
<ol>
<li>help_text 可以做描述文档使用</li>
<li>manytomanyfield  through 可以定制manytomany表</li>
</ol>
</li>
<li><p>合并 迁移数据, 把数据交给amdin后台管理</p>
</li>
</ol>
</li>
<li><p>数据的展示:</p>
<ol>
<li><p>添加了部分数据之后,我们需要把数据给展示出来,运用我们之间学习的知识,做一个电影的数据展示接口</p>
<p> 课堂练习: 1.做一个把所有电影列表展示出来的接口(get方法)</p>
</li>
<li><p>思路梳理:</p>
<ol>
<li>我们需要把数据库的里面的电影信息都展示出来,展示分为两种 一种是遍历一个列表 一种是获取一条数据的详细信息 我们一般来说 遍历只需要大致的信息,而获取详细信息需要更多的信息和关联信息比如演员 演员的相关文章等等</li>
<li>所以我们需要一个 view 一个url 两个serializer</li>
<li>views根据不同的请求 来给出不同的serializer展示信息</li>
</ol>
</li>
<li><p>代码实现(基础):</p>
<ol>
<li><p>我们获取详细信息的时候 我们需要 </p>
<ol>
<li>电影名</li>
<li>电影是否是热门电影</li>
<li>电影是否是最新电影</li>
<li>上映时间</li>
<li>电影类型</li>
<li>电影制片类型(2D,3D)</li>
<li>电影目前的状态(上映中 下架中等等)</li>
<li>电影的部分演员 导演</li>
<li>id号</li>
<li>点赞数量</li>
<li>影片长度</li>
<li>国家</li>
<li>分数(评级)</li>
<li>用户浏览数量<br>…</li>
</ol>
</li>
<li><p>但是我们获取列表的时候只需要</p>
<ol>
<li>电影名</li>
<li>电影想看次数</li>
<li>评分</li>
</ol>
<blockquote>
<p>movie.serializer.py</p>
</blockquote>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from rest_framework import serializers</span><br><span class="line">	</span><br><span class="line">from .models import MovieDetail</span><br><span class="line">class MovieListSerializer(serializers.ModelSerializer):</span><br><span class="line">    class Meta:</span><br><span class="line">        model &#x3D; MovieDetail</span><br><span class="line">        fields &#x3D; (&#39;name&#39;,&#39;status&#39;,&#39;user_want_num&#39;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class MovieDetailSerializer(serializers.ModelSerializer):</span><br><span class="line">    class Meta:</span><br><span class="line">        model &#x3D; MovieDetail</span><br><span class="line">        fields &#x3D; &quot;__all__&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>movie.views.py</p>
</blockquote>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from rest_framework import viewsets</span><br><span class="line"></span><br><span class="line">from .models import MovieDetail</span><br><span class="line"></span><br><span class="line">from .serializers import MovieListSerializer</span><br><span class="line">	</span><br><span class="line">class MovieViewSet(viewsets.ReadOnlyModelViewSet):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    获取电影信息接口</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    queryset &#x3D; MovieDetail.objects.all()</span><br><span class="line">    def get_serializer_class(self):</span><br><span class="line">        if self.action &#x3D;&#x3D; &#39;list&#39;:</span><br><span class="line">            return MovieListSerializer</span><br><span class="line">        if self.action &#x3D;&#x3D; &#39;retrieve&#39;:</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>代码实现 高级</p>
<ol>
<li>通过上面的接口可以看到,很多数据是没有详细的信息的, 比如kind_category,他只有id号,但是没有具体的信息,我们需要获取这些具体的信息来返回给用户</li>
</ol>
<p>  知识点:</p>
<pre><code> 1. 我们需要遍历嵌套的序列化数据
 2. 我们可以通过加入其它的serializer到字段里面取,他就会自动的给我们遍历出嵌套的关系
 3. 如果是manytomany关系 我们需要定义参数 many=true

     &gt;movie.serializers.py
         
         
         <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from rest_framework import serializers</span><br><span class="line">			</span><br><span class="line">from .models import MovieDetail, MovieCountry, SubTitle, MovieStaff, MovieStaffCategory, </span><br><span class="line">MovieKindCategory,MovieTypeCategory</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class MovieListSerializer(serializers.ModelSerializer):</span><br><span class="line">    class Meta:</span><br><span class="line">        model &#x3D; MovieDetail</span><br><span class="line">        fields &#x3D; (&#39;name&#39;, &#39;status&#39;, &#39;user_want_num&#39;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class MovieCountrySerializer(serializers.ModelSerializer):</span><br><span class="line">    class Meta:</span><br><span class="line">        model &#x3D; MovieCountry</span><br><span class="line">        fields &#x3D; &quot;__all__&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class SubTitleSerializer(serializers.ModelSerializer):</span><br><span class="line">    class Meta:</span><br><span class="line">        model &#x3D; SubTitle</span><br><span class="line">        fields &#x3D; &quot;__all__&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class MovieStaffSerializer(serializers.ModelSerializer):</span><br><span class="line">    class Meta:</span><br><span class="line">        model &#x3D; MovieStaff</span><br><span class="line">        fields &#x3D; &quot;__all__&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class MovieStaffCategorySerializer(serializers.ModelSerializer):</span><br><span class="line">    class Meta:</span><br><span class="line">        model &#x3D; MovieStaffCategory</span><br><span class="line">        fields &#x3D; &quot;__all__&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class MovieKindCategorySerializer(serializers.ModelSerializer):</span><br><span class="line">    class Meta:</span><br><span class="line">        model &#x3D; MovieKindCategory</span><br><span class="line">        fields &#x3D; &quot;__all__&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class MovieTypeCategorySerializer(serializers.ModelSerializer):</span><br><span class="line">    class Meta:</span><br><span class="line">        model &#x3D; MovieTypeCategory</span><br><span class="line">        fields &#x3D; &quot;__all__&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class MovieDetailSerializer(serializers.ModelSerializer):</span><br><span class="line">    movie_state &#x3D; MovieCountrySerializer(many&#x3D;True, read_only&#x3D;True)</span><br><span class="line">    sub_title &#x3D; SubTitleSerializer(many&#x3D;True, read_only&#x3D;True)</span><br><span class="line">    staffs &#x3D; MovieStaffSerializer(many&#x3D;True, read_only&#x3D;True)</span><br><span class="line">    kind_category &#x3D; MovieKindCategorySerializer(many&#x3D;True, read_only&#x3D;True)</span><br><span class="line">    type_category &#x3D; MovieTypeCategorySerializer(many&#x3D;True, read_only&#x3D;True)</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        model &#x3D; MovieDetail</span><br><span class="line">        fields &#x3D; &quot;__all__&quot;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
         
         
</code></pre>
</li>
<li><p>我们需要统计用户点赞数量和打分情况</p>
<ol>
<li><p>新建点赞和打分情况的类视图(有打分和修改打分,有点赞和取消点赞)</p>
<p> 代码知识点:</p>
<pre><code> 1. 如果两个类都引用的话 会造成循环引用,所以使用第三方来操作两个类
 2. serializers 里面有 hiddenfields 可以隐藏我们需要的值,然后使用                  
 3. serializers.CurrentUserDefault() 可以取出当前用户
</code></pre>
<blockquote>
<p>user_movie_operations.models.py</p>
</blockquote>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">	from django.db import models</span><br><span class="line">from django.contrib.auth import get_user_model</span><br><span class="line"># Create your models here.</span><br><span class="line"></span><br><span class="line">from movie.models import MovieDetail</span><br><span class="line"></span><br><span class="line">User &#x3D; get_user_model()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class UserStarMovie(models.Model):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    用户对电影的评分,一个用户可以对多个电影评分,一部电影也可以拥有多个用户的评分,用户评分之后</span><br><span class="line">    就不能再去评分这个电影了</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    STAR &#x3D; (</span><br><span class="line">        (&#39;1&#39;, &#39;&#39;),</span><br><span class="line">        (&#39;2&#39;, &#39;&#39;),</span><br><span class="line">        (&#39;3&#39;, &#39;&#39;),</span><br><span class="line">        (&#39;4&#39;, &#39;&#39;),</span><br><span class="line">        (&#39;5&#39;, &#39;&#39;),</span><br><span class="line">        (&#39;6&#39;, &#39;&#39;),</span><br><span class="line">        (&#39;7&#39;, &#39;&#39;),</span><br><span class="line">        (&#39;8&#39;, &#39;&#39;),</span><br><span class="line">        (&#39;9&#39;, &#39;&#39;),</span><br><span class="line">        (&#39;10&#39;, &#39;&#39;),</span><br><span class="line">    )</span><br><span class="line">    user &#x3D; models.ForeignKey(User, verbose_name&#x3D;&#39;评论用户&#39;, help_text&#x3D;&#39;评论用户&#39;)</span><br><span class="line">    movie &#x3D; models.ForeignKey(MovieDetail, verbose_name&#x3D;&#39;所属电影&#39;, help_text&#x3D;&#39;所属电影&#39;)</span><br><span class="line">    star &#x3D; models.CharField(max_length&#x3D;2, choices&#x3D;STAR, </span><br><span class="line">    verbose_name&#x3D;&#39;用户对电影的评分&#39;, help_text&#x3D;&#39;用户对电影的评分&#39;)</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name &#x3D; &#39;用户评论一部电影&#39;</span><br><span class="line">        verbose_name_plural &#x3D; verbose_name</span><br><span class="line"></span><br><span class="line">        unique_together &#x3D; (&quot;user&quot;, &quot;movie&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class UserFavMovie(models.Model):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    用户点赞一个电影</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    user &#x3D; models.ForeignKey(User, verbose_name&#x3D;&#39;点赞用户&#39;, help_text&#x3D;&#39;点赞用户&#39;)</span><br><span class="line">    movie &#x3D; models.ForeignKey(MovieDetail, verbose_name&#x3D;&#39;所属电影&#39;, help_text&#x3D;&#39;所属电影&#39;)</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name &#x3D; &#39;用户评论一部电影&#39;</span><br><span class="line">        verbose_name_plural &#x3D; verbose_name</span><br><span class="line"></span><br><span class="line">        unique_together &#x3D; (&quot;user&quot;, &quot;movie&quot;)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>user_movie_operations.serializers.py</p>
</blockquote>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">	from rest_framework import serializers</span><br><span class="line">from django.contrib.auth import get_user_model</span><br><span class="line">from .models import UserStarMovie,UserFavMovie</span><br><span class="line"></span><br><span class="line">from movie.serializers import MovieListSerializer</span><br><span class="line"></span><br><span class="line">User &#x3D; get_user_model()</span><br><span class="line"></span><br><span class="line"># class UserStarMovieSerializer(serializers.ModelSerializer):</span><br><span class="line">#     model &#x3D; UserStarMovie</span><br><span class="line">#     fields &#x3D; &quot;__all__&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class UserFavMovieCreateSerializer(serializers.ModelSerializer):</span><br><span class="line">    user &#x3D; serializers.HiddenField(</span><br><span class="line">        default&#x3D;serializers.CurrentUserDefault()</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        model &#x3D; UserFavMovie</span><br><span class="line">        fields &#x3D; (&quot;user&quot;,&quot;movie&quot;,&quot;id&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class UserFavMovieReadSerializer(serializers.ModelSerializer):</span><br><span class="line">    user &#x3D; serializers.HiddenField(</span><br><span class="line">        default&#x3D;serializers.CurrentUserDefault()</span><br><span class="line">    )</span><br><span class="line">    movie &#x3D; MovieListSerializer(many&#x3D;False)</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        model &#x3D; UserFavMovie</span><br><span class="line">        fields &#x3D; (&quot;user&quot;,&quot;movie&quot;,&quot;id&quot;)</span><br><span class="line">	</span><br><span class="line">	</span><br></pre></td></tr></table></figure>
<blockquote>
<p>user_movie_operations.views.py</p>
</blockquote>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">略</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>在遍历电影的时候获取打分获取点赞数量<br> 简介: 我们已经可以让用户对电影打分和点赞,取消点赞了,但是我们需要在浏览电影的时候,把点赞数量和打分情况返回给我们的前端,我们需要在遍历电影的serializer里面做文章</p>
<pre><code>   1. 代码实现:
 
 &gt;movie.serializers.py
 
     <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">from django.db.models import Avg</span><br><span class="line">class MovieListSerializer(serializers.ModelSerializer):</span><br><span class="line">   fav_num &#x3D; serializers.SerializerMethodField(read_only&#x3D;True)</span><br><span class="line">   star_num &#x3D; serializers.SerializerMethodField(read_only&#x3D;True)</span><br><span class="line">				</span><br><span class="line">   def get_star_num(self, obj):</span><br><span class="line">       score &#x3D; UserStarMovie.objects.filter(movie&#x3D;obj).aggregate(Avg(&#39;star&#39;))</span><br><span class="line">       return round(score[&#39;star__avg&#39;],1)</span><br><span class="line">   def get_fav_num(self, obj):</span><br><span class="line">       return UserFavMovie.objects.filter(movie&#x3D;obj).count()</span><br><span class="line">				</span><br><span class="line">   class Meta:</span><br><span class="line">       model &#x3D; MovieDetail</span><br><span class="line">       fields &#x3D; (&#39;name&#39;, &#39;status&#39;, &#39;user_want_num&#39;, &#39;fav_num&#39;, &#39;star_num&#39;)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
       6. 知识点:

 1. 我们可以在serializer里面取定义自定义字段方法,只需要继承SerializerMethodField方法,设置read_only = True,然后在下面写上关于他的函数,固定用法 get_xxxx ,serializer就会自动的帮我们使用自定义方法去约束字段信息
 
 
     &gt;serializers.SerializerMethodField(read_only=True)
 
 2. 我们使用了count(),方法去计算点赞的数量

 3. 我们使用了 aggregate 去做统计数据的平均值
 
</code></pre>
</li>
<li><p>使用缓存系统去升级我们的页面</p>
<ol>
<li>简介:每次请求我们都需要大量的计算用户点赞数量，打分的平均值如果请求数量过多,这势必是一个很大的开销,但是这些数据又是相对固定的,你不会每分钟都更新一次电影吧,所以我们需要在获取信息的页面增加缓存</li>
<li>web后台缓存原理:为什么要做缓存,缓存其实就是把数据存储在redis，或者文件系统中,你每次访问,我就把这个缓存的信息返给你,这样,我们就避免了查询数据库的过大开销</li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="4-评论系统和权限控制"><a href="#4-评论系统和权限控制" class="headerlink" title="4.评论系统和权限控制"></a>4.评论系统和权限控制</h3><ol>
<li><p>简介:</p>
<p> 1.我们的电影下方带有评论,评论有对评论回复功能,显示回复评论功能,然后有评论的点赞行为<br> 2.用户可以去删除评论,修改评论,管理员看评论不当,也可以去删除评论,屏蔽用户发帖的功能</p>
</li>
<li><p>电影评论的基本实现:</p>
<ol>
<li><p>模型梳理:</p>
<ol>
<li>哪个用户去评论</li>
<li>评论哪一部电影</li>
<li>评论的内容</li>
<li>评论的时间</li>
<li>回复评论(也就是所外键是自己)</li>
</ol>
</li>
<li><p>模型代码实现:</p>
<p> 1.知识点: 在外键中 使用 ‘self’ 可以表示自己对应自己</p>
<blockquote>
<p>user_movie_opertions.models.py</p>
</blockquote>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class UserMovieShortComments(models.Model):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    用户对一个电影进行评论</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    user &#x3D; models.ForeignKey(User, verbose_name&#x3D;&#39;评论用户&#39;, help_text&#x3D;&#39;评论用户&#39;)</span><br><span class="line">    movie &#x3D; models.ForeignKey(MovieDetail, verbose_name&#x3D;&#39;评论的电影&#39;, help_text&#x3D;&#39;评论的电影&#39;)</span><br><span class="line">    comments &#x3D; models.TextField(max_length&#x3D;255, verbose_name&#x3D;&#39;短评的内容&#39;, help_text&#x3D;&#39;短片的内容&#39;)</span><br><span class="line">    add_time &#x3D; models.DateTimeField(auto_now&#x3D;True, verbose_name&#x3D;&#39;评论的时间&#39;, help_text&#x3D;&#39;评论时间&#39;)</span><br><span class="line">    reply_to &#x3D; models.ForeignKey(&#39;self&#39;,verbose_name&#x3D;&#39;回复某个评论&#39;,</span><br><span class="line">    help_text&#x3D;&#39;回复某个评论也可以不回复&#39;,null&#x3D;True)</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name &#x3D; &#39;用户对一个电影进行短评论&#39;</span><br><span class="line">        verbose_name_plural &#x3D; verbose_name</span><br><span class="line"></span><br><span class="line">        unique_together &#x3D; (&#39;user&#39;, &#39;movie&#39;)</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>评论思路梳理:</p>
<ol>
<li>用户创建评论</li>
<li>用户可以修改评论(自己的)</li>
<li>用户可以删除评论(自己的)</li>
<li>用户可以查看所有评论(自己的)</li>
<li>用户可以查看评论的详细信息(自己的)</li>
</ol>
</li>
<li><p>评论代码实现:</p>
<ol>
<li><p>逻辑代码</p>
<blockquote>
<p>user_movie_opertions.views.py</p>
</blockquote>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">	</span><br><span class="line">	class UserMovieShortCommentsViewSet(ModelViewSet):</span><br><span class="line">	    &quot;&quot;&quot;</span><br><span class="line">	    create:</span><br><span class="line">	        用户增加一条对电影的评论</span><br><span class="line">	    list:</span><br><span class="line">	        查看自己的所有短评</span><br><span class="line">	    retrieve:</span><br><span class="line">	        查看自己的一条短评</span><br><span class="line">	    update:</span><br><span class="line">	        修改自己的短评信息</span><br><span class="line">	    destroy:</span><br><span class="line">	        删除自己的评论信息</span><br><span class="line">	    &quot;&quot;&quot;</span><br><span class="line">	</span><br><span class="line">	    serializer_class &#x3D; UserMovieShortCommentsCreateSerializer</span><br><span class="line">	    queryset &#x3D; UserMovieShortCommentsCreateSerializer.Meta.model.objects.all()</span><br><span class="line">	    permission_classes &#x3D; (IsAuthenticated,)</span><br><span class="line">	</span><br><span class="line">	    def get_throttles(self):</span><br><span class="line">	        if self.action &#x3D;&#x3D; &quot;create&quot;:</span><br><span class="line">	            return [t() for t in (OncePerDayUserThrottle,)]</span><br><span class="line">	</span><br><span class="line">	&#96;&#96;&#96;		</span><br><span class="line">2. 限制用户的速度限速代码</span><br><span class="line"></span><br><span class="line">	&gt;user\_movie_opertions.throttles.py</span><br><span class="line">	</span><br></pre></td></tr></table></figure>
<pre><code> from rest_framework.throttling import UserRateThrottle

 
 class OncePerDayUserThrottle(UserRateThrottle):
     rate = &#39;10/minute&#39;
</code></pre>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">			</span><br><span class="line">3. 升级版,用户评论的权限控制逻辑</span><br><span class="line">	</span><br><span class="line">	1. 简介:</span><br><span class="line">		之前的代码逻辑为用户只能浏览自己的帖子,删除自己的帖子,修改自己的帖子。但是这样的代码逻辑过于简单,我们无法把这些评论交由专门的管理员去管理这些帖子。所以我们需要让某些管理员能够管理其他用户的帖子。这就不仅仅的需要判断一下帖子属于谁这么简单了。我们需要存储帖子的权限是什么,谁能够操控这些权限。</span><br><span class="line">	</span><br><span class="line">	2. 逻辑分析:</span><br><span class="line">	</span><br><span class="line">		1. 首先建立管理员组</span><br><span class="line">		2. 在发帖的时候对用户(个人)和管理员(组)授权</span><br><span class="line">		3. 授权内容为:</span><br><span class="line">			用户: 查看 删除 修改 这个篇帖子</span><br><span class="line">			管理员组: 查看 删除 这个篇帖子</span><br><span class="line">	    4. 用户发帖如果被设置为不能发帖的状态,用户就不能发帖</span><br><span class="line">	3. 代码实现:</span><br><span class="line">		</span><br><span class="line">		1.在创建帖子的时候去添加权限</span><br><span class="line">		&gt;user\_movie_operations.views.py</span><br><span class="line">		</span><br></pre></td></tr></table></figure></li>
</ol>
<p> class UserMovieShortCommentsViewSet(ModelViewSet):</p>
<pre><code> &quot;&quot;&quot;
 create:
     用户增加一条对电影的评论
 list:
     查看自己的所有短评
 retrieve:
     查看自己的一条短评
 update:
     修改自己的短评信息
 destroy:
     删除自己的评论信息
 &quot;&quot;&quot;

 serializer_class = UserMovieShortCommentsCreateSerializer
 queryset = UserMovieShortCommentsCreateSerializer.Meta.model.objects.all()
 permission_classes = (IsAuthenticated,)

 def perform_create(self, serializer):
     user = self.request._user
     group = Group.objects.get_or_create(name=&#39;site_managers&#39;)[0]
     #在创建这篇帖子的时候,授予权限
     #然后再在做操作的时候,查看验证有木有这个权限
     instance = serializer.save()
     assign_perm(&#39;change_usermovieshortcomments&#39;, user, instance)
     assign_perm(&#39;delete_usermovieshortcomments&#39;, user, instance)
     assign_perm(&#39;delete_usermovieshortcomments&#39;, group, instance)


 def get_throttles(self):
     if self.action == &quot;create&quot;:
         return [t() for t in (OncePerDayUserThrottle,)]
</code></pre>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2. 在必要的时候去查看权限</span><br><span class="line">&gt;user_movie_operations.serialziers.py</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p> class UserMovieShortCommentsCreateSerializer(serializers.ModelSerializer):</p>
<pre><code> # 创建短评论的用户
 user = serializers.HiddenField(
     default=serializers.CurrentUserDefault()
 )

 update = serializers.SerializerMethodField(read_only=True)
 delete = serializers.SerializerMethodField(read_only=True)

 def get_update(self, ins):
     user = self.context[&#39;request&#39;]._user

     return &#39;change_usermovieshortcomments&#39; in get_perms(user,ins)

 def get_delete(self, ins):
     user = self.context[&#39;request&#39;]._user
     return &#39;delete_usermovieshortcomments&#39; in get_perms(user,ins)

 class Meta:
     model = UserMovieShortComments
     fields = (&#39;id&#39;,&#39;user&#39;, &quot;movie&quot;, &quot;comments&quot;, &#39;reply_to&#39;,&#39;update&#39;,&#39;delete&#39;)
</code></pre>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">		</span><br><span class="line">4.过多评论 我们需要给他分页,筛选评论</span><br><span class="line"></span><br><span class="line">&gt;参见 分页部分</span><br><span class="line"></span><br><span class="line">### 5. 支付功能的原理与实现</span><br><span class="line"></span><br><span class="line">1. 简介: 我们需要为网站加上支付的功能,他是网站能存活下去的基本</span><br><span class="line"></span><br><span class="line">2. 支付流程: </span><br><span class="line"></span><br><span class="line">	1. 用户在网站内选择想要的商品,点击支付功能</span><br><span class="line">	2. 网站后台先查看用户是否合法,商品是否还有剩余等等</span><br><span class="line">	3. 检查合格后,网站把用户想买的商品锁定起来,以免其他人来购买,并根据付款金额,商品,付款人生成流水号。</span><br><span class="line">	4. 第三步骤还不能成为订单号,因为这个时候用户还没有付款,所以我们需要占时的锁定这个商品。生成流水号,交给用户要支付的平台。</span><br><span class="line">	5. 支付平台会生成支付链接返回给网站后台</span><br><span class="line">	6. 网站后台把支付链接交给用户</span><br><span class="line">	7. 用户通过支付链接付款 </span><br><span class="line">	8. 付款完成后 平台会通过网站支付已经成功</span><br><span class="line">	9. 网站校验平台推送的支付成功信息,没有问题就会把商品交给用户</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	####路梳理</span><br><span class="line">	角色:</span><br><span class="line">	</span><br><span class="line">	    1. 用户</span><br><span class="line">	    2 .网站后台</span><br><span class="line">	    3. 支付平台</span><br><span class="line">	</span><br><span class="line">	 交互:</span><br><span class="line">	 </span><br><span class="line">	     1. 用户是在平台上面给钱,收钱的也是平台</span><br><span class="line">	     2. 平台是发送通知让后台知道用户已经给钱了</span><br><span class="line"></span><br><span class="line">3. 电影项目逻辑梳理:</span><br><span class="line"></span><br><span class="line">	1. 用户选中还没有锁定或者售出的电影座位（用户其实够买的是电影片场里面的座位）</span><br><span class="line">	2. 用户提交够买或者订购的申请</span><br><span class="line">	3. 系统再次检测座位是否被锁定住或者出售</span><br><span class="line">	4. 系统生成一个流水号(为什么叫流水号,因为这个时候用户还没有给钱,他可以取消不给钱,所以只是一个临时的订单叫做流水号） 流水号里面包含用户信息,订单价格,要购买的商品信息(座位)</span><br><span class="line">	5. 系统把这个流水号信息,和要支付的信息交给支付宝或者微信等第三方平台。第三方平台会生成一个支付链接,我们把这个支付链接转交给用户。</span><br><span class="line">	6. 用户一旦得到了支付链接之后,就会在网页或者app里面去跳转 然后支付</span><br><span class="line">	7. 平台收到用户支付的钱之后,会通知系统里面的一个收货接口。</span><br><span class="line">	8. 系统收到收货接口支付成功或者失败的通知之后,把商品正式的提交给那个用户</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">### &lt;span id&#x3D;&quot;django-celery&quot;&gt;5.缓存系统(django-cache)&lt;&#x2F;span&gt;		</span><br><span class="line"></span><br><span class="line">1. django 缓存简介:</span><br><span class="line">	1. django的缓存很灵活,你可以设置缓存到memcached,文件,数据库系统,也可以共享缓存</span><br><span class="line"></span><br><span class="line">2. 缓存分类设置:</span><br><span class="line"></span><br><span class="line">	1. Memcahed缓存:</span><br><span class="line">	</span><br></pre></td></tr></table></figure>
<p> CACHES = {</p>
<pre><code> &#39;default&#39;: &#123;
     &#39;BACKEND&#39;: &#39;django.core.cache.backends.memcached.MemcachedCache&#39;,
     &#39;LOCATION&#39;: &#39;127.0.0.1:11211&#39;,
 &#125;
</code></pre>
<p> }</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">2. 数据库缓存:</span><br><span class="line">	</span><br></pre></td></tr></table></figure>
<p> CACHES = {</p>
<pre><code> &#39;default&#39;: &#123;
     &#39;BACKEND&#39;: &#39;django.core.cache.backends.db.DatabaseCache&#39;,
     &#39;LOCATION&#39;: &#39;my_cache_table&#39;,
 &#125;
</code></pre>
<p> }</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">创建缓存表,使用数据库缓存之前，你必须用这个命令来创建缓存表：</span><br><span class="line">	</span><br></pre></td></tr></table></figure>

<p> python manage.py createcachetable</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">3. 文件系统:</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p> CACHES = {</p>
<pre><code> &#39;default&#39;: &#123;
     &#39;BACKEND&#39;: &#39;django.core.cache.backends.filebased.FileBasedCache&#39;,
     &#39;LOCATION&#39;: &#39;/var/tmp/django_cache&#39;,
 &#125;
</code></pre>
<p> }</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">4. 缓存时间全局设置:</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>  ‘TIMEOUT’: 60</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">		</span><br><span class="line">3. 缓存函数视图</span><br><span class="line"></span><br><span class="line">			</span><br><span class="line">			</span><br><span class="line">	1. 使用函数视图 加上装饰器,查看页面是否会缓存</span><br><span class="line">	</span><br><span class="line">		&gt;my\_test.cache_view.py</span><br><span class="line">		</span><br><span class="line">		在装饰器后面加上cache_page(10) 表示缓存10秒</span><br><span class="line">		</span><br></pre></td></tr></table></figure>
<pre><code> from django.views.decorators.cache import cache_page
 @cache_page(10)
 def cache_view(request):
     pass
</code></pre>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">			</span><br><span class="line">2. 同时 我们也可以在url上面加上缓存</span><br><span class="line"></span><br><span class="line">	&gt;my\_test.urls.py</span><br><span class="line">		   </span><br><span class="line">		   </span><br></pre></td></tr></table></figure>
<pre><code>    from django.views.decorators.cache import cache_page
    ...
    url(r&#39;^test13/$&#39;,cache_page(10)(cache_view))
    
</code></pre>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">		</span><br><span class="line">4. django-redis缓存:</span><br><span class="line">		通过这个设置开启redis缓存功能</span><br><span class="line">		</span><br></pre></td></tr></table></figure>
<p> CACHES = {</p>
<pre><code> &#39;default&#39;: &#123;
     &#39;BACKEND&#39;: &#39;django_redis.cache.RedisCache&#39;,
     &#39;LOCATION&#39;: &#39;redis://your_host_ip:6379&#39;,
     &quot;OPTIONS&quot;: &#123;
         &quot;CLIENT_CLASS&quot;: &quot;django_redis.client.DefaultClient&quot;,
          &quot;PASSWORD&quot;: &quot;yoursecret&quot;,
     &#125;,
 &#125;,
</code></pre>
<p> }</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">		</span><br><span class="line">	1. 使用redis-cli去查看缓存的数据</span><br><span class="line">	2. 查看redis中的key</span><br><span class="line">	</span><br><span class="line">5. 高级缓存配置</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	1. TIMEOUT 全局缓存时间设置</span><br><span class="line">	2. OPTIONS:</span><br><span class="line">		</span><br><span class="line">		1. MAX_ENTRIES:高速缓存允许的最大条目数，超出这个数则旧值将被删除. 这个参数默认是300.</span><br><span class="line">		2. CULL_ENTRIES:当达到MAX_FREQUENCY 的时候,被删除的条目比率。 实际比率是 1 &#x2F; CULL_FREQUENCY, 所以设置CULL_FREQUENCY 为2会在达到MAX_ENTRIES 所设置值时删去一半的缓存。 这个参数应该是整数，默认为 3.</span><br><span class="line">		</span><br><span class="line">		 把 CULL_FREQUENCY的值设置为 0 意味着当达到MAX_ENTRIES时,缓存将被清空。 某些缓存后端 (database尤其)这将以很多缓存丢失为代价,大大 提高接受访问的速度。</span><br><span class="line">		 </span><br><span class="line">		3. KEY_PREFIX: 缓存的key的开头</span><br><span class="line">		4. KEY_FUNCTION:一个字符串，其中包含一个函数的虚线路径，该函数定义了如何将前缀，版本和密钥组合成最终缓存密钥。</span><br><span class="line">		5. VERSION：由Django服务器生成的缓存键的默认版本号。</span><br><span class="line">	</span><br><span class="line">	3. 实际的示例</span><br><span class="line">	</span><br></pre></td></tr></table></figure></li>
</ol>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">6. drf_extension缓存配置</span><br><span class="line">	1. 库简介: drf_extension是一个drf的扩展库,它带有对view的扩展和缓存的扩展</span><br><span class="line">	2. 使用的必要条件: 必须是继承了 APIView的类才能使用</span><br><span class="line">	3. CacheResponseMixin 类视图的缓存</span><br><span class="line">		1. 他一般会缓存 get方法</span><br><span class="line">		2. 使用方法</span><br><span class="line">			</span><br><span class="line">	</span><br><span class="line">	4. 配置简介</span><br><span class="line"></span><br><span class="line">		1. DEFAULT_CACHE_RESPONSE_TIMEOUT全局设置缓存的时间</span><br><span class="line">		2. DEFAULT_USE_CACHE 选择使用哪个缓存方式去缓存,一搬不会写</span><br><span class="line">		3. </span><br><span class="line">		</span><br></pre></td></tr></table></figure>
<pre><code> REST_FRAMEWORK_EXTENSIONS = &#123;
     &#39;DEFAULT_CACHE_RESPONSE_TIMEOUT&#39;: 60 * 15
     &#39;DEFAULT_USE_CACHE&#39;: &#39;special_cache&#39;
 &#125;
 
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">5. 使用方式:</span><br><span class="line">	</span><br><span class="line">	&gt;mytest.cache_view.py</span><br><span class="line">	</span><br></pre></td></tr></table></figure>
     from rest_framework_extensions.cache.mixins import CacheResponseMixin
     class BookViewSet(CacheResponseMixin,viewsets.ReadOnlyModelViewSet):


 queryset = Book.objects.all()
 serializer_class = BookSerializer
 
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">7. drf_extension配置深度解析</span><br><span class="line">			</span><br><span class="line">			</span><br><span class="line">### &lt;span id&#x3D;&quot;django-celery&quot;&gt;5.队列任务(django-celery)&lt;&#x2F;span&gt;</span><br><span class="line"></span><br><span class="line">1. 队列任务的基础概念:</span><br><span class="line">    1. 高并发环境下，由于来不及同步处理，我们需要把这些东西交给一套系统去排队处理。这样不会导致我们主程序卡死,从而不能接受请求，出现大面积404</span><br><span class="line">    2. 画图解释队列架构</span><br><span class="line">    </span><br><span class="line">2. 队列任务的实现方式:</span><br><span class="line">    1. 我们以django celery为例:</span><br><span class="line">        1. 调度器:就是我们的django-celery 他去调用这些任务的执行,我们存储任务执行的结果</span><br><span class="line">        2. 任务执行器:我们发送邮件的函数就是一个任务执行器,celery可以去调度他执行发送邮件的任务。也可以在任务较多的时候。然他排队去执行。</span><br><span class="line">        3. 消息中间件: 我们把一个任务交给了任务执行器。但是任务多久完成，我们是不知道的。他可能在排队,也可能执行失败。也可能执行成功。我们需要一个东西去存储他目前的状态。通用的消息中间件有 redis rabbitMQ。</span><br><span class="line">    2. 队列任务大致流程梳理:</span><br><span class="line">        1. 把发送邮件的任务交给django-celery处理,并把调用任务的变量传递给django-celery</span><br><span class="line">        2. django-celery把这个任务给定一个唯一任务id号,然后存储到消息中间件中(这里我们用redis)</span><br><span class="line">        3. django-celery 把这个任务排队,等到能执行这个任务的时候，他去调用我们发送邮件程序去发送邮件</span><br><span class="line">        4. 当任务执行成功或者失败他都会把这个消息存入到我们的消息中间件中.</span><br><span class="line"></span><br><span class="line"> 3. django-celery:</span><br><span class="line"> </span><br><span class="line">     1. 安装 celery</span><br><span class="line">     </span><br><span class="line">     		第一个安装 celery 第二个安装 python redis 让python能使用redis 第三个安装celery的任务执行结果存储地区</span><br><span class="line">     		</span><br></pre></td></tr></table></figure>
          pip install celery
          pip install redis
          pip install django-celery-results
          
      
      <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">2. 使用redis作为消息中间件,安装redis</span><br><span class="line">	</span><br><span class="line">		[redis安装使用相关知识点](#redis)</span><br><span class="line">		</span><br><span class="line">3. django中配置celery</span><br><span class="line"></span><br><span class="line">    1. 在配置文件下面新加celery.py</span><br><span class="line"></span><br><span class="line">   		</span><br><span class="line">   	</span><br><span class="line">    </span><br><span class="line">    		&gt; drf\_movie_rimi.celery.py</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
         from __future__ import absolute_import, unicode_literals
         import os
         from celery import Celery
         
         # set the default Django settings module for the &#39;celery&#39; program.
         os.environ.setdefault(&#39;DJANGO_SETTINGS_MODULE&#39;, &#39;drf_movie_rimi.settings&#39;)
         
         #启动项目的名字 最好和项目名字一样 broker中间件  backend 存储结果的地方
         app = Celery(&#39;drf_movie_rimi&#39;,
                      broker=&#39;redis://localhost:6379&#39;,
                      backend=&#39;redis://localhost:6379&#39;
         
                      )
         
         #在redis中以CELERY
         app.config_from_object(&#39;django.conf:settings&#39;, namespace=&#39;CELERY&#39;)
         
         #使celery能够读取到所有apps里面分配的任务
         app.autodiscover_tasks()
</code></pre>
</li>
</ol>
<pre><code>         <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">   </span><br><span class="line">2. drf\_movie_rimi.settings.py</span><br><span class="line"></span><br></pre></td></tr></table></figure>
          
          INSTALLED_APPS = [
                    ...
                &#39;django_celery_results&#39;,
            ]
            
            ...
            
            CELERY_RESULT_BACKEND = &#39;django-db&#39;
          <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">安装好app之后做迁移</span><br><span class="line"></span><br></pre></td></tr></table></figure>
          makemigrations
          migrate
          <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">      </span><br><span class="line">3. 在项目配置的init.py里面加入启动文件</span><br><span class="line"></span><br><span class="line">	drf\_movie_rimi.__init__.py</span><br><span class="line">  				</span><br></pre></td></tr></table></figure>
              
              from __future__ import absolute_import, unicode_literals

            # This will make sure the app is always imported when
            # Django starts so that shared_task will use this app.
            from .celery import app as celery_app
            
            __all__ = (&#39;celery_app&#39;,)
              
              <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">         </span><br><span class="line">4. 启动和使用celery</span><br><span class="line"></span><br><span class="line">	1. 启动django</span><br><span class="line">	2. 在命令行中启动celery</span><br><span class="line">		        </span><br><span class="line">          &gt;启动命令 虚拟环境下 项目目录下执行</span><br><span class="line">          </span><br></pre></td></tr></table></figure>
              celery -A drf_movie_rimi worker -l info 
              <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">     </span><br><span class="line">3. 把我们的发送邮件任务转移给celery去执行</span><br><span class="line"></span><br><span class="line">	   1. 按照固定用法引入包</span><br><span class="line">	   2. 在函数前面加入@shared_task装饰器来使他成为队列任务</span><br><span class="line"></span><br><span class="line">     &gt;users.tasks.py</span><br><span class="line">     </span><br></pre></td></tr></table></figure>
              
                 # Create your tasks here
                    from __future__ import absolute_import, unicode_literals
                    from celery import shared_task
                    from utitls import send_sms_email
                    
                    ...
                    
                    
                    @shared_task
                    def reg_send_mail(title, context, to_mail):
                        res = send_sms_email.my_send_mail(title, context, to_mail)
                    
                        success_context = &#39;向&#123;&#125;邮箱发送注册验证码成功,信息内容:&#123;&#125;&#39;.format(to_mail, context)
                        fail_context = &quot;向&#123;&#125;发送邮箱验证码失败&quot;.format(to_mail)
                    
                        if res == 1:
                            return success_context
                        return fail_context

              <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">3. 在views里面去调用队列,引入我们刚才的队列函数,使用xxx.delay()去唤醒他</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		&gt; users.views.py</span><br></pre></td></tr></table></figure>
                     
                    class UserRegisterCaptchaCreateViewSet(CreateModelMixin, GenericViewSet):
                        queryset = UserRegisterCaptchaCreateSerializer.Meta.model.objects.all()
                        serializer_class = UserRegisterCaptchaCreateSerializer
                    
                        def perform_create(self, serializer):
                            data = serializer.validated_data
                            captcha = &#39;您的验证码为&#123;&#125;&#39;.format(data[&#39;captcha&#39;])
                            #res = my_send_mail(&#39;注册验证码&#39;,captcha,data[&#39;email&#39;])
                            reg_send_mail.delay(&#39;注册验证码&#39;,captcha,data[&#39;email&#39;])
                            
                            ...
                     
                     <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">		            	 </span><br><span class="line">		        4. 在我们的admin后台去查看结果</span><br><span class="line"></span><br><span class="line">		5. 总结：</span><br><span class="line">		</span><br><span class="line">			1. 队列任务是一个抽象概念</span><br><span class="line">			2. 队列任务的标准是叫你去实现 </span><br><span class="line">				1. 调度队列的程序(celery) </span><br><span class="line">				2. 消息中间件-broker(redis)</span><br><span class="line">				3. 执行结果存储器 backend (mysql或者redis)</span><br><span class="line">			3. celery只是python里面去实现了队列的程序,当然你可以自己写,java那些也有自己的程序			</span><br><span class="line">   				</span><br><span class="line"></span><br><span class="line">   			</span><br><span class="line">   			</span><br><span class="line">    </span><br><span class="line">  </span><br><span class="line"> </span><br><span class="line">### &lt;span id&#x3D;&quot;redis&quot;&gt;6.redis&lt;&#x2F;span&gt;   </span><br><span class="line"></span><br><span class="line">1. redis的简介:</span><br><span class="line">	1. redis是一个nosql数据库</span><br><span class="line">	2. redis他是一个存在于内存上面的数据库</span><br><span class="line">	3. redis他有时候会用来做缓存</span><br><span class="line">	4. nosql数据库一张表只能有一个特定的用途</span><br><span class="line"></span><br><span class="line">2. redis的安装:</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">3. redis的配置,他的软件的用法</span><br><span class="line"></span><br><span class="line">	1. Makefile: make &amp;&amp; make install的安装依据文档,如果你安装出问题的话,就可以去找个文件</span><br><span class="line">	2. redis.conf 配置文件</span><br><span class="line">	3. sentinel.conf 我们redis 哨兵,高可用配置,如果reids崩掉的话,监听,然后做出决策</span><br><span class="line">	4. 文件夹 src:</span><br><span class="line">		1. redis-benchmark redis的压测工具</span><br><span class="line">		2. redis-server redis-cli redis服务器 reids客户端</span><br><span class="line">		3. redis-sentinel 启动我们的哨兵</span><br><span class="line">	5. 配置文件（redsi.conf）:</span><br><span class="line">		1. bind 127.0.0.1  启动的监听ip 一般监听内网ip</span><br><span class="line">		2. port 6379 监听端口 一般会改掉</span><br><span class="line">		3. masterauth &lt;master-password&gt; 主从备份密码 主的密码 等于你主机 requirepass 前提是你配置了 slaveof</span><br><span class="line">		4. requirepass redis密码</span><br><span class="line">		5. slaveof 127.0.0.1 6379 配置主从 主的ip和端口 让自己成为slaveof（从库）</span><br><span class="line">		7. dump.rdb redis的持久化数据</span><br><span class="line">		8. save 60 10000 表示 60秒之内 你有大于等于10000次数据变化,他就会给你存储到rdb(硬盘)上面</span><br><span class="line">		9. redis有两种存储方式, 一种是rdb 一种是 aof 默认是rdb</span><br><span class="line">			1. rdb的原理是一段时间内把你磁盘的镜像存储下来(思考git) 坏处是:发生灾难,灾难的期间的数据是没有的 比如你 12.00保存了数据 12.00：30秒发生灾难, 30秒的数据就没有了</span><br><span class="line">			2. aof 存储 append only 原理是把你每一次数据库的变化记录下来，恢复数据的时候,根据你每次的变化来推演。 好处: 发生灾难了数据很会很小。坏处:无法达到性能或者是很耗性能</span><br><span class="line">		10. 数据过期命令:</span><br><span class="line">			expire value second 给一个key设置过期时间,完成之后就被删除</span><br><span class="line">			最主要的地方用在缓存数据上面</span><br><span class="line">			</span><br><span class="line">			ttl key可以去看他有还有多少的寿命</span><br><span class="line">			</span><br><span class="line">		</span><br><span class="line">	6. redis命令:</span><br><span class="line">		-h hostip</span><br><span class="line">		-p 端口</span><br><span class="line">		-a 密码</span><br><span class="line">		tips:如果你的密码错误,你是可以链接的,但是你无法看到数据</span><br><span class="line">		链接命令: src&#x2F;redis-cli -h 192.168.0.169 -p 16379 -a rimi12345678</span><br><span class="line">	</span><br><span class="line">	7. redis的数据库结构:</span><br><span class="line">		1. 前提</span><br><span class="line">			1. 大前提 redis 数据库结构是基于nosql的 所以的数据库都是 key value</span><br><span class="line">			2. 没有主键和外键 比如设了外键,主键被删了之后,他的没有任何影响</span><br><span class="line">			3. 表于表之间没有任何关系 </span><br><span class="line">		2. 数据结构:</span><br><span class="line">			1. string 字符串 key value 存储字符串和数字 </span><br><span class="line">				命令: </span><br><span class="line">					1. set 设置key和value</span><br><span class="line">					2. get 获取key所代表的value</span><br><span class="line">					3. incr 自增1</span><br><span class="line">					4. decr 自减1</span><br><span class="line">					5. incrby key num </span><br><span class="line">					6. decrby </span><br><span class="line">			2. hash 散列表:</span><br><span class="line">				1. 相当于一个 dict 但是只有一层</span><br><span class="line">				  命令:</span><br><span class="line">				  	hset 设置一个散列表 hset person1 name luhan age 25 gender renyao</span><br><span class="line">				  	hgetall key 获取hash里面的所有key value</span><br><span class="line">				  	</span><br><span class="line">				  	hmget key field1 field2 ... 获取执行的value  hmget person1 name age</span><br><span class="line">				  	hmset key fiels value 精准的修改hash表(已经存在)里值,没有就会新建</span><br><span class="line">				  	</span><br><span class="line">				  2. 性能优化:</span><br><span class="line">				 		1. 一般不会用hash表,我们用string表来代替他（存入json）</span><br><span class="line">						2. 或者他推荐我们去使用 hgetall命令,少用hmget</span><br><span class="line">				</span><br><span class="line">			3. zset 有序集合:</span><br><span class="line">			</span><br><span class="line">				1. 是一个有排名的集合数据，每一条数据他都有排名:</span><br><span class="line">				</span><br><span class="line">				2. 命令：</span><br><span class="line">					1. 添加数据: zadd key score value 给定数据的分数</span><br><span class="line">					2. 取出数据并且排名: ZREVRANGE hackers 0 -1 withscores</span><br><span class="line">						1. withscores 会把分数一并的给你显示出来</span><br><span class="line">					3. zcard value 统计我们的集合里面的数据量</span><br><span class="line">					4. zscore value key 取出某个key的分数</span><br><span class="line">					5. zrem value key  移除某个分数</span><br><span class="line">			4. set 无序结合:</span><br><span class="line">				</span><br><span class="line">				1. 是一个无需集合:</span><br><span class="line">				</span><br><span class="line">					2.命令:</span><br><span class="line">						1. sadd key value1 value2 .... 添加值到我们的集合里面去</span><br><span class="line">						2. smembers key 获取集合里面的信息</span><br><span class="line">						3. scard key 获取集合的数据</span><br><span class="line">						4. sdiff 集合的差集</span><br><span class="line">			5. list 双向列表结构:</span><br><span class="line">			</span><br><span class="line">				1. 他是双向列表,他可以把数据从左边或者右边压入,压入之后可以左右弹出</span><br><span class="line">				2. 可以用这个来做队列任务</span><br><span class="line"></span><br><span class="line">				</span><br><span class="line">			6. eval redis脚本:</span><br><span class="line">			</span><br><span class="line">				执行脚本可以保证你的数据的一致性</span><br><span class="line">				</span><br><span class="line">				script表示的是lua脚本:</span><br><span class="line">				</span><br><span class="line">					1. lua申明变量需要local</span><br><span class="line">					2. lua拼接字符串需要 ..</span><br><span class="line">					3. 调用脚本的时候 使用 redis.call() 跟你的命令</span><br><span class="line">					4. keys args相当于传递参数进去，在脚本里面大写入KEYS[1]</span><br><span class="line">					</span><br></pre></td></tr></table></figure>
            def new_user():
                script = &quot;&quot;&quot;
                    local user_id = redis.call(&quot;incr&quot;, KEYS[1])
                    local hash_table_name = &quot;user:&quot;..user_id
                    redis.call(&quot;zadd&quot;,&quot;user_set&quot;,user_id,hash_table_name)
                    redis.call(&quot;hmset&quot;,hash_table_name,&quot;name&quot;,user_id)
                &quot;&quot;&quot;
                script1 = r.register_script(script)
                x = script1(keys=[&quot;user_id&quot;], args=[])
            
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">6. pipeline:</span><br><span class="line">	可以帮我们加速redis执行效率,一次性执行所有的所有操作</span><br><span class="line">	</span><br></pre></td></tr></table></figure>
                with r.pipeline() as p:
                    for i in range(100000):
                        user_id = p.incr(&#39;user_id&#39;)
                        hash_table_name = &quot;user:&#123;&#125;&quot;.format(user_id)
                        p.zadd(&#39;user_set&#39;, user_id, hash_table_name)
                        p.hmset(hash_table_name, &#123;&quot;name&quot;: &quot;user:&#123;&#125;&quot;.format(user_id), &#39;password&#39;: 
                        &#39;rimiaaa&#123;&#125;&#39;.format(user_id)&#125;)
                    p.execute()
                            
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">				</span><br><span class="line">		1. 实验：设计一张表:</span><br><span class="line"></span><br><span class="line">			要求: 使用redis来做用户表</span><br><span class="line">			</span><br><span class="line">			    1. 存入账户密码</span><br><span class="line">			    2. 用户新建之后,id自增</span><br><span class="line">			    3. 可以查看到所有的用户</span><br><span class="line">			    4. 可以统计用户的数量</span><br><span class="line">		</span><br><span class="line">			mytest.redis_test.py</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 8.django-gurdian 控制用户权限的逻辑</span><br><span class="line"></span><br><span class="line">1. 简介:</span><br><span class="line">	  1. 他是django第三方权限管理扩展库</span><br><span class="line">	  2. 为什么要使用权限管理系统?我们参考一下百度贴吧,你发的帖子会被管理员删除掉,当然你自己也可以删除掉自己的帖子,但是你是不能删除其他人或者管理员发出的帖子的。这就是一个典型的权限管理系统</span><br><span class="line">	  3. RBAC-&gt;刚才所讲的问题我们可以通过RBAC模型去解决,RBAC的全称为 role-based access control,即基于角色的访问控制。</span><br><span class="line">	  4. 那其实我们刚才的那个问题就可以化解为授予权限,和在要使用权限的时候去检查这个用户是否有权限。</span><br><span class="line">	  5. django-guradian是一个实现了rabc模型的强大工具,它是专门扩展django权限管理的第三方库。</span><br><span class="line">	  6. 具有授予,删除,查看权限等等丰富的功能</span><br><span class="line">	  7. 官网: http:&#x2F;&#x2F;django-guardian.readthedocs.io&#x2F;en&#x2F;latest&#x2F;</span><br><span class="line">	  8. 他是对象级别的权限控制</span><br><span class="line">	  9. django是model级别的权限控制</span><br><span class="line"></span><br><span class="line">2. 安装:</span><br><span class="line">	  1. 库安装</span><br><span class="line">	  </span><br></pre></td></tr></table></figure>
  $ pip install django-guardian
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2. 把guardian放入django的apps里面</span><br><span class="line">		</span><br></pre></td></tr></table></figure>
      INSTALLED_APPS = (
     ...
     &#39;guardian&#39;,
    )
  
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">	  </span><br></pre></td></tr></table></figure>
  $ pip install django-guardian
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">3. api使用规范:</span><br><span class="line">	1. 权限授予: guardian.shortcuts.assign_perm(perm, user_or_group, obj&#x3D;None) </span><br><span class="line">	</span><br><span class="line">	2. 权限查看:guardian.shortcuts.get_perms(user_or_group, obj)—返回一个用户给这个对象权限的list,其实就是一个含有perm的list</span><br><span class="line">	</span><br><span class="line">	3. 参数说明: perm要授予的权限(删除或者修改权限),user_or_group授予权限的用户或者用户组(用户),obj被操控的对象(博文</span><br><span class="line">	4. 在model中加入权限: model的Meta里面可以加扩展permissons,这个扩展的permissions就是上面perm参数</span><br><span class="line"></span><br><span class="line">4. 实现我们的逻辑代码:</span><br><span class="line">	1. 我们这个时候就需要给用户分组了 </span><br><span class="line">		1. 普通用户 （使用普通的网站功能）</span><br><span class="line">		2. 网站管理员 （管理用户回复评论中的帖子,删帖,修改用户帖子,屏蔽用户发帖）</span><br><span class="line">		3. 系统管理员 (添加或者删除网站管理员)</span><br><span class="line">	2. 用户发帖之后,帖子是一个对象,所以我们的授权就应该在这个时候去完成</span><br><span class="line">		1. 删除权限</span><br><span class="line">		2. 修改权限</span><br><span class="line">		3. 授予网站管理员和发帖用户这个权限</span><br><span class="line"></span><br><span class="line">5. 底层原理:</span><br><span class="line">	其实是数据库的中数据的记录</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 9.pagination django的分页</span><br><span class="line">1. 简介 如果页面的数据过多,那么我们不能在页给他显示完成,我们可以采用分页显示数据,减少数据库压力</span><br><span class="line">2. 实现分页所需要的部件:</span><br><span class="line">	最大数据量 返回给前端表示我们有多少的数据量</span><br><span class="line">	每页数据量 返回给前端每页能显示多少的数据量 当然这个可以修改</span><br><span class="line">	当前页面页码 让前端知道当前在哪个页面上面</span><br><span class="line">3. django中的分页配置:</span><br><span class="line"></span><br><span class="line">    1. 全局默认配置 当我们配置好了之后,会在list页面看到我们的分页信息</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
    
    REST_FRAMEWORK = &#123;
            ...
        
            &#39;DEFAULT_PAGINATION_CLASS&#39;: &#39;rest_framework.pagination.LimitOffsetPagination&#39;,
            &#39;PAGE_SIZE&#39;: 10
&#125;
    
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">2. 定制化分页配置</span><br><span class="line"></span><br><span class="line">	参数解释:</span><br><span class="line">		1. page_size 默认每页个数</span><br><span class="line">		2. page_size_query_param 在url里面去设置每页个数</span><br><span class="line">		3. max_page_size 每页最大的个数 page_size_query_param最大值不能超过他</span><br><span class="line"></span><br></pre></td></tr></table></figure>
    
    
    from rest_framework.pagination import PageNumberPagination
    
    class LargeResultsSetPagination(PageNumberPagination):
        page_size = 10
        page_size_query_param = &#39;page_size&#39;
        max_page_size = 100
        
        
    class MovieShortCommentsReadAllViewSet(ListModelMixin,GenericViewSet):
        &quot;&quot;&quot;
        查看相关电影的所有评论,并且返回可以管理这条评论
        &quot;&quot;&quot;
        serializer_class = UserMovieShortCommentsCreateSerializer
        queryset = UserMovieShortCommentsCreateSerializer.Meta.model.objects.all()
    
        pagination_class = LargeResultsSetPagination
    
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">### 10.django-filter 筛选数据</span><br><span class="line">1. 简介:</span><br><span class="line"></span><br><span class="line">2. django-filter使用方法:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	1. 在drf中使用filter去搜索或者排序数据</span><br><span class="line">		用法: 1.我们使用 filters去激活 filter_backends让他拥有搜索和排序的功能,然后我们给定搜索和排序的位置即可</span><br><span class="line">		</span><br><span class="line">		</span><br></pre></td></tr></table></figure>
    
    from rest_framework import filters
    class MovieViewSet(mixins.ListModelMixin,mixins.RetrieveModelMixin,mixins.
    UpdateModelMixin,viewsets.GenericViewSet):
        &quot;&quot;&quot;
        获取电影信息接口
        &quot;&quot;&quot;
    
        queryset = MovieDetail.objects.all()
        filter_backends = (filters.SearchFilter, filters.OrderingFilter)
        search_fields = (&#39;name&#39;,)
        ordering_fields = (&#39;id&#39;,)
    
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">2. 分类筛选器</span><br><span class="line"></span><br><span class="line">   1. 简介: 通过上面的配置我们已经可以去搜索字段,然后给定字段的排序了,但是我们还需要分类筛选信息,比如电影类型筛选,上映时间筛选等等</span><br><span class="line">   2. 安装:</span><br><span class="line">   </span><br><span class="line">   	    1. 官方地址: http:&#x2F;&#x2F;django-filter.readthedocs.io&#x2F;en&#x2F;master&#x2F;</span><br><span class="line">   		 2. 安装命令:</span><br><span class="line">   			</span><br></pre></td></tr></table></figure>
               $ pip install django_fliter
               <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">		</span><br><span class="line">3. 使用方法:</span><br><span class="line"></span><br><span class="line">	1. movies.views.py</span><br><span class="line">	 </span><br></pre></td></tr></table></figure>
            
            class MovieViewSet(mixins.ListModelMixin,mixins.RetrieveModelMixin,
            mixins.UpdateModelMixin,viewsets.GenericViewSet):
                &quot;&quot;&quot;
                获取电影信息接口
                &quot;&quot;&quot;
            
                queryset = MovieDetail.objects.all()
                filter_backends = (DjangoFilterBackend,filters.SearchFilter, filters.OrderingFilter)
                search_fields = (&#39;name&#39;,)
                ordering_fields = (&#39;id&#39;,)
                filter_class = MovieDetailFilter
            
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">2. 在专门的filters中去配置 类似于我们的form功能</span><br><span class="line"></span><br></pre></td></tr></table></figure>
            
            import django_filters.rest_framework as filters
            from .models import MovieDetail
            
            
            class MovieDetailFilter(filters.FilterSet):
                class Meta:
                    model = MovieDetail
                    fields = [
                        &#39;name&#39;,
                    ]
            
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">		</span><br><span class="line">4. fields使用方法:</span><br><span class="line">	 可以用更多选择去约束筛选条件</span><br><span class="line">	 </span><br></pre></td></tr></table></figure>
         
             class Meta:
                model = MovieDetail
                fields = &#123;
                    &#39;name&#39;:[&#39;exact&#39;, &#39;contains&#39;]
                &#125;
         
         <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">			 </span><br><span class="line">			 上面的会给你创建两个筛选字段 一个给你精确匹配，一个给你模糊pip</span><br><span class="line">			 </span><br><span class="line">		5. 筛选条件详解</span><br><span class="line">		</span><br><span class="line">			1. exact 精确匹配</span><br><span class="line">			2. contains icontains 包含 i表示忽略大小写</span><br><span class="line">			3. gt gte 大于 大于等于</span><br><span class="line">			4. lt lte 小于 小于等于</span><br><span class="line">		6. 外键的使用:</span><br><span class="line">		    1. __ 表示魔术方法</span><br><span class="line">		    2. kind_category__name</span><br><span class="line">	   		</span><br><span class="line">	   			</span><br><span class="line">	   		</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">### 11.admin 后台管理定制化</span><br><span class="line"></span><br><span class="line">1. 简介:</span><br><span class="line">   我们的admin里面包含了字段的所有信息,但是有些信息我们是不想让人去修改的,比如所点赞数量,浏览数量,或者其他定制化的东西,所以我们需要调用admin里面的方法去修改我们对admin里面字段的约束</span><br><span class="line">   </span><br><span class="line">2. 约束修改方法:</span><br><span class="line">	1. 只显示哪些字段</span><br><span class="line">		fields &#x3D; (&#39;name&#39;, &#39;status&#39;) </span><br><span class="line">	2. 不显示哪些字段</span><br><span class="line">		exclude &#x3D; (&#39;name&#39;,)</span><br><span class="line">	3. 哪些字段在一行里面去显示:</span><br><span class="line">	</span><br><span class="line">		1. 注意点: 不能把外键放在里面</span><br><span class="line">	</span><br><span class="line">		fields &#x3D; ((&#39;name&#39;, &#39;status&#39;), &#39;sub_title&#39;)</span><br><span class="line">	4. 组合字段展示,可以把字段放在合集里面展示，给出标题和样式。collapse表示下拉栏</span><br><span class="line">	</span><br></pre></td></tr></table></figure>
        fieldsets = (
            (None, &#123;
                &#39;fields&#39;: ((&#39;name&#39;, &#39;status&#39;), &#39;sub_title&#39;)
            &#125;),
            (&#39;Advanced options&#39;, &#123;
                &#39;classes&#39;: (&#39;collapse&#39;,),
                &#39;fields&#39;: (&#39;view_num&#39;, &#39;is_banner&#39;),
            &#125;),
        )
    
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">5. list_display:</span><br><span class="line">	顾名思义,会在展示list的时候,展示哪些数据</span><br><span class="line">	</span><br></pre></td></tr></table></figure>
        ...    
        list_display = (&#39;id&#39;,&#39;name&#39;,&#39;status&#39;)
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">6. list_display_links:</span><br><span class="line">	配置了之后会生成一个连接 直接连接过去:</span><br><span class="line">	</span><br></pre></td></tr></table></figure>
    ...    
    list_display_links = (&#39;name&#39;, &#39;status&#39;)
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">7. list_editable:</span><br><span class="line">	</span><br><span class="line">	可以直接在list面板修改值,不用进入到里面去修改</span><br><span class="line">	</span><br><span class="line">	list_editable &#x3D; (&quot;status&quot;,)</span><br><span class="line">	</span><br><span class="line">8. list_filter:</span><br><span class="line">	可以在list面板配置分类功能 </span><br><span class="line">	</span><br></pre></td></tr></table></figure>
    list_filter = (&#39;kind_category&#39;,)
    
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">9. search_fields:</span><br><span class="line">	搜索框搜索页面</span><br><span class="line">	</span><br></pre></td></tr></table></figure>
    search_fields = [&#39;name&#39;]
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">10. inlines:</span><br><span class="line">	如果有外键指向了这个model,就可以使用inlines方便的管理,而不用去外面单独的编辑外键</span><br><span class="line">	</span><br></pre></td></tr></table></figure>
    class Img(admin.TabularInline):

        model = MovieImages
    
        inlines = [Img]
    
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">	11. 其他:</span><br><span class="line">	</span><br><span class="line">	   https:&#x2F;&#x2F;yiyibooks.cn&#x2F;xx&#x2F;Django_1.11.6&#x2F;ref&#x2F;contrib&#x2F;admin&#x2F;index.html</span><br><span class="line"></span><br><span class="line">3. 富文本编辑器 ckeditor</span><br><span class="line"></span><br><span class="line">    1. 官网 https:&#x2F;&#x2F;github.com&#x2F;django-ckeditor&#x2F;django-ckeditor</span><br><span class="line"></span><br><span class="line">    2. 安装</span><br><span class="line"></span><br></pre></td></tr></table></figure>
    pip install django-ckeditor
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">在settings的app里面加入 ckeditor</span><br><span class="line"></span><br><span class="line">新建文件夹 static</span><br><span class="line"></span><br><span class="line">配置 STATIC_ROOT &#x3D; static</span><br><span class="line"></span><br></pre></td></tr></table></figure>
                
        CKEDITOR_UPLOAD_PATH = &#39;ckeditor/&#39;
        CKEDITOR_RESTRICT_BY_USER = True
        CKEDITOR_BROWSE_SHOW_DIRS = True
        CKEDITOR_RESTRICT_BY_DATE = True
        CKEDITOR_IMAGE_BACKEND = &#39;PIL&#39;
        CKEDITOR_BASEPATH = &quot;/static/ckeditor/ckeditor/&quot;
        CKEDITOR_CONFIGS = &#123;
            &#39;default&#39;: &#123;
                &#39;update&#39;: [&#39;Image&#39;, &#39;Update&#39;, &#39;Flash&#39;, &#39;Table&#39;, &#39;HorizontalRule&#39;, 
                &#39;Smiley&#39;, &#39;SpecialChar&#39;, &#39;PageBreak&#39;],
                &#39;skin&#39;: &#39;moono&#39;,
                # &#39;skin&#39;: &#39;office2013&#39;,
                &#39;toolbar_Basic&#39;: [
                    [&#39;Source&#39;, &#39;-&#39;, &#39;Bold&#39;, &#39;Italic&#39;]
                ],
                # &#39;toolbar_YourCustomToolbarConfig&#39;: [
                #     &#123;&#39;name&#39;: &#39;document&#39;, &#39;items&#39;: [&#39;Source&#39;, &#39;-&#39;, &#39;Save&#39;, &#39;NewPage&#39;,
                 &#39;Preview&#39;, &#39;Print&#39;, &#39;-&#39;, &#39;Templates&#39;]&#125;,
                #     &#123;&#39;name&#39;: &#39;clipboard&#39;, &#39;items&#39;: [&#39;Cut&#39;, &#39;Copy&#39;, &#39;Paste&#39;,
                 &#39;PasteText&#39;, &#39;PasteFromWord&#39;, &#39;-&#39;, &#39;Undo&#39;, &#39;Redo&#39;]&#125;,
                #     &#123;&#39;name&#39;: &#39;editing&#39;, &#39;items&#39;: [&#39;Find&#39;, &#39;Replace&#39;, &#39;-&#39;, 
                &#39;SelectAll&#39;]&#125;,
                #     &#123;&#39;name&#39;: &#39;forms&#39;,
                #      &#39;items&#39;: [&#39;Form&#39;, &#39;Checkbox&#39;, &#39;Radio&#39;, &#39;TextField&#39;, 
                &#39;Textarea&#39;, &#39;Select&#39;, &#39;Button&#39;, &#39;ImageButton&#39;,
                #                &#39;HiddenField&#39;]&#125;,
                #     &#39;/&#39;,
                #     &#123;&#39;name&#39;: &#39;basicstyles&#39;,
                #      &#39;items&#39;: [&#39;Bold&#39;, &#39;Italic&#39;, &#39;Underline&#39;, &#39;Strike&#39;, 
                &#39;Subscript&#39;, &#39;Superscript&#39;, &#39;-&#39;, &#39;RemoveFormat&#39;]&#125;,
                #     &#123;&#39;name&#39;: &#39;paragraph&#39;,
                #      &#39;items&#39;: [&#39;NumberedList&#39;, &#39;BulletedList&#39;, &#39;-&#39;, 
                &#39;Outdent&#39;, &#39;Indent&#39;, &#39;-&#39;, &#39;Blockquote&#39;, &#39;CreateDiv&#39;, &#39;-&#39;,
                #                &#39;JustifyLeft&#39;, &#39;JustifyCenter&#39;, &#39;JustifyRight&#39;, 
                &#39;JustifyBlock&#39;, &#39;-&#39;, &#39;BidiLtr&#39;, &#39;BidiRtl&#39;,
                #                &#39;Language&#39;]&#125;,
                #     &#123;&#39;name&#39;: &#39;links&#39;, &#39;items&#39;: [&#39;Link&#39;, &#39;Unlink&#39;, &#39;Anchor&#39;]&#125;,
                #     &#123;&#39;name&#39;: &#39;insert&#39;,
                #      &#39;items&#39;: [&#39;Image&#39;, &#39;Flash&#39;, &#39;Table&#39;, &#39;HorizontalRule&#39;, 
                &#39;Smiley&#39;, &#39;SpecialChar&#39;, &#39;PageBreak&#39;, &#39;Iframe&#39;]&#125;,
                #     &#39;/&#39;,
                #     &#123;&#39;name&#39;: &#39;styles&#39;, &#39;items&#39;: [&#39;Styles&#39;, &#39;Format&#39;, &#39;Font&#39;, &#39;FontSize&#39;]&#125;,
                #     &#123;&#39;name&#39;: &#39;colors&#39;, &#39;items&#39;: [&#39;TextColor&#39;, &#39;BGColor&#39;]&#125;,
                #     &#123;&#39;name&#39;: &#39;tools&#39;, &#39;items&#39;: [&#39;Maximize&#39;, &#39;ShowBlocks&#39;]&#125;,
                #     &#123;&#39;name&#39;: &#39;about&#39;, &#39;items&#39;: [&#39;About&#39;]&#125;,
                #     &#39;/&#39;,  # put this to force next toolbar on new line
                #     &#123;&#39;name&#39;: &#39;yourcustomtools&#39;, &#39;items&#39;: [
                #         # put the name of your editor.ui.addButton here
                #         &#39;Preview&#39;,
                #         &#39;Maximize&#39;,
                #
                #     ]&#125;,
                # ],
                # &#39;toolbar&#39;: &#39;YourCustomToolbarConfig&#39;,  # put selected toolbar config here
                # # &#39;toolbarGroups&#39;: [&#123; &#39;name&#39;: &#39;document&#39;, &#39;groups&#39;: 
                [ &#39;mode&#39;, &#39;document&#39;, &#39;doctools&#39; ] &#125;],
                # # &#39;height&#39;: 291,
                # # &#39;width&#39;: &#39;100%&#39;,
                # # &#39;filebrowserWindowHeight&#39;: 725,
                # # &#39;filebrowserWindowWidth&#39;: 940,
                # # &#39;toolbarCanCollapse&#39;: True,
                # # &#39;mathJaxLib&#39;: &#39;//cdn.mathjax.org/mathjax/2.2-latest/MathJax.js
                ?config=TeX-AMS_HTML&#39;,
                # &#39;tabSpaces&#39;: 4,
                # &#39;extraPlugins&#39;: &#39;,&#39;.join([
                #     # &#39;uploadimage&#39;,  # the upload image feature
                #     # your extra plugins here
                #     &#39;div&#39;,
                #     &#39;autolink&#39;,
                #     &#39;autoembed&#39;,
                #     &#39;embedsemantic&#39;,
                #     &#39;autogrow&#39;,
                #     # &#39;devtools&#39;,
                #     &#39;widget&#39;,
                #     &#39;lineutils&#39;,
                #     &#39;clipboard&#39;,
                #     &#39;dialog&#39;,
                #     &#39;dialogui&#39;,
                #     &#39;elementspath&#39;
                # ]),
            &#125;
        &#125;
    
    
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">执行 collectstatic</span><br><span class="line"></span><br><span class="line">在url里面取配置静态文件服务器和ckeditor的</span><br><span class="line"></span><br></pre></td></tr></table></figure>
        
        
        urlpatterns = [
                ...
                url(r&#39;^ckeditor/&#39;, include(&#39;ckeditor_uploader.urls&#39;)),
                ...
            
            ]
        ...
        
        urlpatterns += [
                # 启动一个文件服务器(django的文件服务器 实际上线后使用nginx之类的服务器作为文件服务器)
                url(r&#39;^static/(?P&lt;path&gt;.*)$&#39;, serve, &#123;
                    &#39;document_root&#39;: settings.STATIC_ROOT
                &#125;),
                url(r&#39;^media/(?P&lt;path&gt;.*)$&#39;, serve, &#123;
                    &#39;document_root&#39;: settings.MEDIA_ROOT
                &#125;)
            ]
                    
        
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    </span><br><span class="line">    CKEDITOR_BASEPATH 一定要在结尾加上 &#x2F; 比如 &quot;&#x2F;static&#x2F;ckeditor&#x2F;ckeditor&#x2F;&quot;</span><br><span class="line">    </span><br><span class="line">3. 在model中取替换我们的field即可,然后去admin里面取查看</span><br><span class="line"></span><br></pre></td></tr></table></figure>
    
        from ckeditor_uploader.fields import RichTextUploadingField
        
        class MovieDetail(models.Model):
        ...
        movie_brief = RichTextUploadingField(default=&#39;目前没有还有简介&#39;, max_length=500, 
        verbose_name=&#39;电影简介&#39;, help_text=&#39;电影简介&#39;)
        ...

    
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">	       </span><br><span class="line">### 12. django 文件存储系统</span><br><span class="line"></span><br><span class="line">1. python 文件基础:</span><br><span class="line">	1. 使用python 打开文件:</span><br><span class="line">	</span><br><span class="line">		1. 使用python 打开文件并写入字符串:</span><br><span class="line"></span><br><span class="line">			读写模式:</span><br><span class="line">			</span><br><span class="line">				r: 只读</span><br><span class="line">				</span><br><span class="line">				r+: 读写</span><br><span class="line">				</span><br><span class="line">				w: 只写</span><br><span class="line">				</span><br><span class="line">				w+: 读写</span><br><span class="line">				</span><br><span class="line">				a: 只写(追加写入)</span><br><span class="line">				</span><br><span class="line">				a+: 读写(追加写入)</span><br><span class="line">				</span><br><span class="line">			&gt;my_test.file_test1.py</span><br><span class="line">			</span><br></pre></td></tr></table></figure>
        def test1():
            file = os.path.join(base_dir,&#39;test1.txt&#39;)
            with open(file,&#39;w+&#39;) as f:
                f.write(&#39;hello worasdfld&#39;)
        
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">2. 读取文件 读取大型文件或者打印大型文件的时候需要循环遍历</span><br><span class="line">	</span><br><span class="line">	&gt;my_test.file_test1.py</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
        
        def test3():
            file = os.path.join(base_dir,&#39;test2.txt&#39;)
            with open(file,&#39;r&#39;) as f:
                datas = f.readlines()
                for i in datas:
                    print(i)
        
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">			</span><br><span class="line"></span><br><span class="line">2. form-data x-www-form-urlencoded raw binary区别</span><br><span class="line"></span><br><span class="line">	https:&#x2F;&#x2F;blog.csdn.net&#x2F;shangmingtao&#x2F;article&#x2F;details&#x2F;74463500</span><br><span class="line">	</span><br><span class="line">3. urlencode解释:</span><br><span class="line">	</span><br><span class="line">	因为有时候我们get方法里面的参数会带空格 问号等等,但是这些是我们Url的特殊符号,如果url里面带有了空格问号，他就会执行其他命令。而不是把他作为字符串看待，所以我们需要把们encode 变成url不会识别成特殊符号的字符串，参考我们的正则表达式。</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	&gt;my\_test.file_test1.py</span><br><span class="line"></span><br></pre></td></tr></table></figure>
        
def test4():
    from urllib import parse

    url_test = &#39;www.baidu.com?&#39;
    url_params = &#39;a=阿凡达拉水电费&amp;b=发的说法发?生?的浪费阿斯蒂芬&#39;
    print(url_test+ parse.quote(url_params))
        
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">	思考 post方法需要urlencode吗?</span><br><span class="line"></span><br><span class="line">			</span><br><span class="line">			</span><br><span class="line"></span><br><span class="line">4. django 文件理清思路: static vs media</span><br><span class="line">	</span><br><span class="line">	1. static是静态文件</span><br><span class="line">	2. media是资源文件,资源文件是随时会变的,比如用户上传的头像,后台发布的文章,他是随时会变的</span><br><span class="line">	3. 你看的网页是如何显示的图片的?</span><br><span class="line">		一般会有img标签,浏览器遍历到Img标签,取出img标签里面的关于资源文件(图片,视频的网址),然后访问这个url得到的资源文件,显示给用户去看。</span><br><span class="line">	</span><br><span class="line">	4. 图片是如何生成如何传输的?</span><br><span class="line">	</span><br><span class="line">		计算机以RGB三原色或者其他算法来显示图片,其实对计算机来说,图片就是一个普通的txt文件,里面存放的是把这个图片哪个位置显示哪个颜色的信息。比如1080p就是有 1080*1920个像素点,每个像素点表现什么颜色就是我们里面存入的信息。</span><br><span class="line">		</span><br><span class="line">		那么如何传输,只需要传输txt信息给浏览器,浏览器会根据这些信息来解密,展示图片</span><br><span class="line">		</span><br><span class="line">		jpg,png是什么?</span><br><span class="line">			就是把同一个图片里面的信息加密的方式,就像我们的utf8 utf16等等,加密过程中可能会有部分信息的删除。</span><br><span class="line">	</span><br><span class="line">	5. 那么django的媒体系统是如何设计的?</span><br><span class="line">		</span><br><span class="line">		我们可以指定存储图片的位置, media_root，然后我们上传图片后,图片会存在于文件夹中。数据库里面存储的是图片存储的位置信息</span><br><span class="line">	</span><br><span class="line">5. django文件上传基础:</span><br><span class="line"></span><br><span class="line">	1. django 接受的文件上传模式是 form-data模式,如此他会把我们的文件信息(或者二进制流)放入他的 request.FILES,我们使用post上传一个文件,断点查看files里面的信息。</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">		查看我们传过来的file是什么: 他是一个 inMemoryUploadFile 类</span><br><span class="line">		</span><br><span class="line">	</span><br><span class="line">		&gt;mytest.file_view.py</span><br><span class="line">		</span><br></pre></td></tr></table></figure>
    
    @csrf_exempt
    def test_files(request):
        # write_files(request.FILES[&#39;test_files&#39;])
    
        return HttpResponse(&#39;hello world&#39;)
    
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2. 我们可以把这个二进制数据写入到文件中(这个时候 信息还在变量中(内存))</span><br><span class="line"></span><br><span class="line">	1. 我们使用wb+模式来写入文件 因为图片等文件是用二进制流传入的</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">		&gt;mytest.file_view.py</span><br><span class="line">		</span><br></pre></td></tr></table></figure>
        
        def write_files(file):
            media_dir = os.path.join(BASE_DIR, &#39;media&#39;, &#39;test1&#39;)
            media_file = os.path.join(media_dir, file.name)
        
            with open(media_file, &#39;wb+&#39;) as f:
                #断点查看i 二进制
                for i in file.chunks():
                    f.write(i)
        
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">2. 我们可以利用这个方法把文件写在外部，注意 你需要文件的写入权限</span><br><span class="line"></span><br><span class="line">	&gt;mytest.file_view.py</span><br><span class="line">	</span><br></pre></td></tr></table></figure>
        def write_files_out_side(file):
            media_dir = os.path.dirname(BASE_DIR)
            media_file = os.path.join(media_dir, &#39;test_store&#39;,file.name)
        
            with open(media_file, &#39;wb+&#39;) as f:
                #断点查看i
                for i in file.chunks():
                    f.write(i)
        
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">		</span><br><span class="line"></span><br><span class="line">3. django中自带的文件写入类,我们使用这个类就不用去想我们刚才使用函数方法一样去自己做这些事情了,定义ImageField即可或者FileField。然后我们把inMemoryUploadFile类的对象传递给我们imgfield 他就会自动的帮我们上传完成图片。其实我们刚才的函数是一样的,不过有部分限制:</span><br><span class="line">   1. 图片的传入顶层目录必须是我们在settings中去指定的图片目录。</span><br><span class="line"></span><br><span class="line">   2. 如果图片有重名，他会自动的给我们重命名文件。</span><br><span class="line">   </span><br><span class="line">   3. 他的img字段里面存储的是图片的存储路径,而不是图片</span><br><span class="line"></span><br><span class="line">	&gt;mytest.models.py</span><br><span class="line">	</span><br></pre></td></tr></table></figure>
    class FileTestImage(models.Model):
        name = models.CharField(max_length=20,verbose_name=&#39;文件写入测试名称&#39;)
        img = models.ImageField(upload_to=&#39;test1&#39;,verbose_name=&#39;测试图片&#39;)
    
        class Meta:
            verbose_name = &#39;图片写入测试&#39;
            verbose_name_plural = verbose_name
    
        def __str__(self):
            return self.name
    
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt; mytest.file\_test.py</span><br><span class="line"></span><br></pre></td></tr></table></figure>
    
    @csrf_exempt
    def test_files(request):
    
        data = request.FILES[&#39;test_files&#39;]
        # write_files_out_side(request.FILES[&#39;test_files&#39;])
        FileTestImage.objects.create(name=&#39;测试1&#39;,img=data)
    
    
        return HttpResponse(&#39;hello world&#39;)
    
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">4. 问题:我们存储文件需要分开存储,试想一个大型网站有多少用户,一个文件夹里面存储10w张图片?光是系统打开这个文件都已经够消耗资源了。所以我们需要合理的去分割图片存储的文件。最常见的是以日期为准,比如每个月的图片存在于当月文件夹中，又或者每个文件夹存1000张,存满后换下一文件。但是这一切的核心问题是你需要自己去接管图片存储位置的逻辑,然后做适合业务的算法出来</span><br><span class="line"></span><br><span class="line">5. django 文件存储自定义文件夹:</span><br><span class="line"></span><br><span class="line">    1. 我们可以自定义文件的存储位置,只需要给定upload一个函数(平时我们给定的一个字符串,表示文件定死存储在哪里)</span><br><span class="line">	    </span><br></pre></td></tr></table></figure>
        def test_directory_path(instance, filename):
            ext = filename.split(&#39;.&#39;)[-1]
            filename = &#39;&#123;&#125;.&#123;&#125;&#39;.format(uuid.uuid4().hex[:8], ext)
            # return the whole path to the file
            return &quot;&#123;0&#125;/&#123;1&#125;/&quot;.format(&quot;avatar&quot;, filename)
        
        
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2. 升级版:</span><br><span class="line">    我们需要给定传递给哪个文件夹</span><br><span class="line">     </span><br></pre></td></tr></table></figure>
        
           import uuid
            from django.utils.deconstruct import deconstructible
            from django.utils.timezone import now
            import os
            
            
            @deconstructible
            class UploadToPathAndRename(object):
                def __init__(self, path):
                    year = str(now().year)
                    month = str(now().month)
            
                    self.sub_path = os.path.join(path, year, month)
            
                def __call__(self, instance, filename):
                    ext = filename.split(&#39;.&#39;)[-1]
                    filename = &#39;&#123;&#125;.&#123;&#125;&#39;.format(uuid.uuid4().hex[:8], ext)
                    return os.path.join(self.sub_path, filename)
        
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">		    </span><br><span class="line">	6. </span><br><span class="line"></span><br><span class="line">&lt;!--3. 分布式文件传输</span><br><span class="line"></span><br><span class="line">	1. 新的问题:</span><br><span class="line">		我们已经把图片路径切割为自己定制化的路径了，但是依然有一个问题，一般线上的服务器都是把图片存储在一个专门的目录</span><br><span class="line">		或者一个专门的文件服务器上面,我们这样存在整体代码里面是不可行的。静态文件可以在代码文件里面,但是媒体文件不行。</span><br><span class="line">		</span><br><span class="line">	2. 解决上面的问题其实就是做一个系统把文件可以写到另外的文件夹(本机器中)</span><br><span class="line">	3. 我们可以使用分布式存储库来解决这个问题 django-resto</span><br><span class="line">	</span><br><span class="line"></span><br></pre></td></tr></table></figure>
    $ pip install django-resto
    
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">		</span><br></pre></td></tr></table></figure>
    
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">### 13. django 部署</span><br><span class="line"></span><br><span class="line">1. 基础知识:</span><br><span class="line">	1. 我们的web服务是一个deamon程序,他们需要一直稳定的跑在服务器上面,每当有浏览器请求过来,他就需要去解析报文,然后把含有(get post参数等)的信息传递给我们的程序</span><br><span class="line">	2. web服务也有可能崩掉,所以我们需要一个第三方的程序去监听他,在web服务down的时候去自动的启动</span><br><span class="line"></span><br><span class="line">2. gunicorn 部署</span><br><span class="line">	1. 简介 gunicorn是一个django的cgi服务,它最主要的特点是轻量化 简单配置 可以使用python来做配置文件</span><br><span class="line"></span><br><span class="line">	2. 使用:</span><br><span class="line">	</span><br><span class="line">		1. 安装gunicorn服务</span><br><span class="line">		</span><br></pre></td></tr></table></figure>
        $ pip install gunicorn
        
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2. gunicorn的配置文件</span><br><span class="line"></span><br><span class="line">	</span><br></pre></td></tr></table></figure>
        
        import multiprocessing
        import os
        
        base_dir = os.path.dirname(os.path.abspath(__file__))
        # unix:file_path 使用socket方式
        bind = &quot;0.0.0.0:8009&quot;
        #socket_file = os.path.join(base_dir,&#39;mysocket&#39;,&#39;mysock.sock&#39;)
        #bind = &quot;unix:&#123;&#125;&quot;.format(socket_file)
        # 2-4 x $(NUM_CORES) range
        workers = multiprocessing.cpu_count() * 2 + 1
        #worker_class= &quot;gevent&quot;
        # port = 8002
        backlog = 2048  # 就是设置允许挂起的连接数的最大值
        # timeout默认值：30
        # reload 默认值：False 重载 更改代码的时候重启workers， 只建议在开发过程中开启。
        reload = False
        # daemon以守护进程形式来运行Gunicorn进程。默认值：False
        daemon = False
        # accesslog 设置访问日志存放的地方
        # 默认值：None
        accesslog = os.path.join(base_dir, &#39;log&#39;, &#39;gunicorn&#39;, &#39;access.log&#39;)
        # errorlog 设置错误日志的存放地址
        errorlog = os.path.join(base_dir, &#39;log&#39;, &#39;gunicorn&#39;, &#39;error.log&#39;)

        
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">3. 在django项目下面去启动服务器</span><br><span class="line"></span><br></pre></td></tr></table></figure>
        
        command=/Users/canvas/virtualenvs/django_drf_rimi_teaching/bin/gunicorn -c 
        gunicorn_conf.py drf_movie_rimi.wsgi &amp;
        
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">			</span><br><span class="line">3. superviosr</span><br><span class="line"></span><br><span class="line">	1. 在上面我们完成了gunicorn的部署之后,我们需要一个第三方监听程序去监听他。所以我们决定使用superviosr来做这个事情</span><br><span class="line">	2. supservioser的安装</span><br><span class="line">	</span><br><span class="line">		注意使用sudo 和python 2.4 以上版本，不能使用python3</span><br><span class="line">		</span><br></pre></td></tr></table></figure>
    sudo pip2.7 install supervisor
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">3. 安装完成之后,首选配置</span><br><span class="line"></span><br></pre></td></tr></table></figure>
    
        
        ; Sample supervisor config file.
        ;
        ; For more information on the config file, please see:
        ; http://supervisord.org/configuration.html
        ;
        ; Notes:
        ;  - Shell expansion (&quot;~&quot; or &quot;$HOME&quot;) is not supported.  Environment
        ;    variables can be expanded using this syntax: &quot;%(ENV_HOME)s&quot;.
        ;  - Quotes around values are not supported, except in the case of
        ;    the environment= options as shown below.
        ;  - Comments must have a leading space: &quot;a=b ;comment&quot; not &quot;a=b;comment&quot;.
        ;  - Command will be truncated if it looks like a config file comment, e.g.
        ;    &quot;command=bash -c &#39;foo ; bar&#39;&quot; will truncate to &quot;command=bash -c &#39;foo &quot;.
        
        [unix_http_server]
        file=/tmp/supervisor.sock   ; the path to the socket file
        ;chmod=0700                 ; socket file mode (default 0700)
        ;chown=nobody:nogroup       ; socket file uid:gid owner
        ;username=user              ; default is no username (open server)
        ;password=123               ; default is no password (open server)
        
        [inet_http_server]         ; inet (TCP) server disabled by default
        port=127.0.0.1:9001        ; ip_address:port specifier, *:port for all iface
        username=user              ; default is no username (open server)
        password=123               ; default is no password (open server)
        
        [supervisord]
        logfile=/tmp/supervisord.log ; main log file; default $CWD/supervisord.log
        logfile_maxbytes=50MB        ; max main logfile bytes b4 rotation; default 50MB
        logfile_backups=10           ; # of main logfile backups; 0 means none, default 10
        loglevel=info                ; log level; default info; others: debug,warn,trace
        pidfile=/tmp/supervisord.pid ; supervisord pidfile; default supervisord.pid
        nodaemon=false               ; start in foreground if true; default false
        minfds=1024                  ; min. avail startup file descriptors; default 1024
        minprocs=200                 ; min. avail process descriptors;default 200
        ;umask=022                   ; process file creation umask; default 022
        ;user=chrism                 ; default is current user, required if root
        ;identifier=supervisor       ; supervisord identifier, default is &#39;supervisor&#39;
        ;directory=/tmp              ; default is not to cd during start
        ;nocleanup=true              ; don&#39;t clean up tempfiles at start; default false
        ;childlogdir=/tmp            ; &#39;AUTO&#39; child log dir, default $TEMP
        ;environment=KEY=&quot;value&quot;     ; key value pairs to add to environment
        ;strip_ansi=false            ; strip ansi escape codes in logs; def. false
        
        ; The rpcinterface:supervisor section must remain in the config file for
        ; RPC (supervisorctl/web interface) to work.  Additional interfaces may be
        ; added by defining them in separate [rpcinterface:x] sections.
        
        [rpcinterface:supervisor]
        supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface
        
        ; The supervisorctl section configures how supervisorctl will connect to
        ; supervisord.  configure it match the settings in either the unix_http_server
        ; or inet_http_server section.
        
        [supervisorctl]
        serverurl=unix:///tmp/supervisor.sock ; use a unix:// URL  for a unix socket
        ;serverurl=http://127.0.0.1:9001 ; use an http:// url to specify an inet socket
        ;username=chris              ; should be same as in [*_http_server] if set
        ;password=123                ; should be same as in [*_http_server] if set
        ;prompt=mysupervisor         ; cmd line prompt (default &quot;supervisor&quot;)
        ;history_file=~/.sc_history  ; use readline history if available
        
        ; The sample program section below shows all possible program subsection values.
        ; Create one or more &#39;real&#39; program: sections to be able to control them under
        ; supervisor.
        
        ;[program:theprogramname]
        ;command=/bin/cat              ; the program (relative uses PATH, can take args)
        ;process_name=%(program_name)s ; process_name expr (default %(program_name)s)
        ;numprocs=1                    ; number of processes copies to start (def 1)
        ;directory=/tmp                ; directory to cwd to before exec (def no cwd)
        ;umask=022                     ; umask for process (default None)
        ;priority=999                  ; the relative start priority (default 999)
        ;autostart=true                ; start at supervisord start (default: true)
        ;startsecs=1                   ; # of secs prog must stay up to be running (def. 1)
        ;startretries=3                ; max # of serial start failures when starting (default 3)
        ;autorestart=unexpected        ; when to restart if exited after running (def: unexpected)
        ;exitcodes=0,2                 ; &#39;expected&#39; exit codes used with autorestart (default 0,2)
        ;stopsignal=QUIT               ; signal used to kill process (default TERM)
        ;stopwaitsecs=10               ; max num secs to wait b4 SIGKILL (default 10)
        ;stopasgroup=false             ; send stop signal to the UNIX process group (default false)
        ;killasgroup=false             ; SIGKILL the UNIX process group (def false)
        ;user=chrism                   ; setuid to this UNIX account to run the program
        ;redirect_stderr=true          ; redirect proc stderr to stdout (default false)
        ;stdout_logfile=/a/path        ; stdout log path, NONE for none; default AUTO
        ;stdout_logfile_maxbytes=1MB   ; max # logfile bytes b4 rotation (default 50MB)
        ;stdout_logfile_backups=10     ; # of stdout logfile backups (0 means none, default 10)
        ;stdout_capture_maxbytes=1MB   ; number of bytes in &#39;capturemode&#39; (default 0)
        ;stdout_events_enabled=false   ; emit events on stdout writes (default false)
        ;stderr_logfile=/a/path        ; stderr log path, NONE for none; default AUTO
        ;stderr_logfile_maxbytes=1MB   ; max # logfile bytes b4 rotation (default 50MB)
        ;stderr_logfile_backups=10     ; # of stderr logfile backups (0 means none, default 10)
        ;stderr_capture_maxbytes=1MB   ; number of bytes in &#39;capturemode&#39; (default 0)
        ;stderr_events_enabled=false   ; emit events on stderr writes (default false)
        ;environment=A=&quot;1&quot;,B=&quot;2&quot;       ; process environment additions (def no adds)
        ;serverurl=AUTO                ; override serverurl computation (childutils)
        
        ; The sample eventlistener section below shows all possible eventlistener
        ; subsection values.  Create one or more &#39;real&#39; eventlistener: sections to be
        ; able to handle event notifications sent by supervisord.
        
        ;[eventlistener:theeventlistenername]
        ;command=/bin/eventlistener    ; the program (relative uses PATH, can take args)
        ;process_name=%(program_name)s ; process_name expr (default %(program_name)s)
        ;numprocs=1                    ; number of processes copies to start (def 1)
        ;events=EVENT                  ; event notif. types to subscribe to (req&#39;d)
        ;buffer_size=10                ; event buffer queue size (default 10)
        ;directory=/tmp                ; directory to cwd to before exec (def no cwd)
        ;umask=022                     ; umask for process (default None)
        ;priority=-1                   ; the relative start priority (default -1)
        ;autostart=true                ; start at supervisord start (default: true)
        ;startsecs=1                   ; # of secs prog must stay up to be running (def. 1)
        ;startretries=3                ; max # of serial start failures when starting (default 3)
        ;autorestart=unexpected        ; autorestart if exited after running (def: unexpected)
        ;exitcodes=0,2                 ; &#39;expected&#39; exit codes used with autorestart (default 0,2)
        ;stopsignal=QUIT               ; signal used to kill process (default TERM)
        ;stopwaitsecs=10               ; max num secs to wait b4 SIGKILL (default 10)
        ;stopasgroup=false             ; send stop signal to the UNIX process group (default false)
        ;killasgroup=false             ; SIGKILL the UNIX process group (def false)
        ;user=chrism                   ; setuid to this UNIX account to run the program
        ;redirect_stderr=false         ; redirect_stderr=true is not allowed for eventlisteners
        ;stdout_logfile=/a/path        ; stdout log path, NONE for none; default AUTO
        ;stdout_logfile_maxbytes=1MB   ; max # logfile bytes b4 rotation (default 50MB)
        ;stdout_logfile_backups=10     ; # of stdout logfile backups (0 means none, default 10)
        ;stdout_events_enabled=false   ; emit events on stdout writes (default false)
        ;stderr_logfile=/a/path        ; stderr log path, NONE for none; default AUTO
        ;stderr_logfile_maxbytes=1MB   ; max # logfile bytes b4 rotation (default 50MB)
        ;stderr_logfile_backups=10     ; # of stderr logfile backups (0 means none, default 10)
        ;stderr_events_enabled=false   ; emit events on stderr writes (default false)
        ;environment=A=&quot;1&quot;,B=&quot;2&quot;       ; process environment additions
        ;serverurl=AUTO                ; override serverurl computation (childutils)
        
        ; The sample group section below shows all possible group values.  Create one
        ; or more &#39;real&#39; group: sections to create &quot;heterogeneous&quot; process groups.
        
        ;[group:thegroupname]
        ;programs=progname1,progname2  ; each refers to &#39;x&#39; in [program:x] definitions
        ;priority=999                  ; the relative start priority (default 999)
        
        ; The [include] section can just contain the &quot;files&quot; setting.  This
        ; setting can list multiple files (separated by whitespace or
        ; newlines).  It can also contain wildcards.  The filenames are
        ; interpreted as relative to this file.  Included files *cannot*
        ; include files themselves.
        
        ;[include]
        ;files = relative/directory/*.ini
        
        [program:django3]
        command=/Users/canvas/virtualenvs/django_drf_rimi_teaching/bin/gunicorn -c 
        gunicorn_conf.py drf_movie_rimi.wsgi &amp;
        directory=/Users/canvas/project/django_drf_rimi_teaching/drf_movie_rimi
        startsecs=0
        stopwaitsecs=0
        autostart=true
autorestart=true


    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">4. 启动它</span><br><span class="line"></span><br></pre></td></tr></table></figure>
    

    supervisord -c supervisor1.conf    
    
    
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">		</span><br><span class="line">	5. 使用supervisorctl去查看状态</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 14. nginx 服务器</span><br><span class="line"></span><br><span class="line">1. nginx 服务器说明:</span><br><span class="line">	</span><br><span class="line">	nginx是一款反向代理服务器 -&gt; 代理服务器意思是本身不会处理任何代码,他只是将你的请求转发给其他端口处理 比如他可以把服务交给django服务程序处理</span><br><span class="line">	</span><br><span class="line">	nginx是纯C语言实现的 性能很高 他的意义是引擎的意思</span><br><span class="line">	</span><br><span class="line">	一般我们会把nginx作为文件服务器,因为文件服务器的特性是没有什么逻辑程序在其中,只需要单纯的按照协议来发送文件请求即可,这点也符合nginx的代码简单 效率高的特点。</span><br><span class="line">	</span><br><span class="line">	我们一般会把django中的文件交给nginx处理,django只负责逻辑代码，比如复杂的数据库请求，序列化等等</span><br><span class="line">	</span><br><span class="line">2. nginx的安装</span><br><span class="line"></span><br><span class="line">	1. 官网下载 编译安装</span><br><span class="line">	</span><br></pre></td></tr></table></figure>
    $ http://nginx.org/download/nginx-1.15.2.tar.gz
    
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">解压</span><br><span class="line"></span><br></pre></td></tr></table></figure>
    $ ./configure
    $ sudo make &amp;&amp; make install
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2. nginx启动命令和重启命令</span><br><span class="line"></span><br></pre></td></tr></table></figure>
    $ sudo /usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx_test.conf 
    
    $ sudo /usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx_test.conf -s reload
    
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">3. nginx服务器配置解释</span><br><span class="line"></span><br><span class="line">	1. user 后面跟启动用户 和用户所在的用户组</span><br><span class="line">	2. worker_processes 启动多少个线程</span><br><span class="line">	3. events 需要多少最大连接</span><br><span class="line">	4. error_log 错误日志</span><br><span class="line">	5. http 代码http模块 nginx里面只能有一个http&#123;&#125;</span><br><span class="line">	6. server 表示虚拟服务器 一个http里面可以有很多虚拟服务器</span><br><span class="line">	7. listen 表示绑定到哪个端口</span><br><span class="line">	8. location 表示端口对应的url匹配模式(正则表达式)</span><br><span class="line">	9. root表示如果是文件服务的话，他会去哪里找到文件</span><br><span class="line">	10. proxy_pass 表示转发到哪个服务上面去</span><br><span class="line"></span><br></pre></td></tr></table></figure>
#使用nginx的 用户和用户组
user  canvas staff;
worker_processes  2;

#错误日志地方
error_log  /Users/canvas/project/django_drf_rimi_teaching/drf_movie_rimi/log/nginx/error_run.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events &#123;
    worker_connections  4096;
&#125;


http &#123;
    include       mime.types;
    default_type  application/octet-stream;


    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;

    #监听18080端口
    server &#123;
        charset utf-8;
        listen 18080;

        #client_max_body_size 5;
           #location /static &#123;
        #    client_max_body_size 5m;
           #    alias /root/project/moudu_movie_online_test/backend/static;
        #    allow all;
           #&#125;

        location / &#123;
            client_max_body_size 5m;
               proxy_set_header Host $host;
               #把18080端口转发给8005
               proxy_pass http://127.0.0.1:8005;
        &#125;

        error_log /Users/canvas/project/django_drf_rimi_teaching/drf_movie_rimi/log/nginx/error.log;
        access_log /Users/canvas/project/django_drf_rimi_teaching/drf_movie_rimi/log/nginx/access.log;
    &#125;

    server &#123;
        listen 10081;
        root  /Users/canvas/project/django_drf_rimi_teaching/drf_movie_rimi;
        location ~ .*\.(js|css|html|gif|jpg|jpeg|png|bmp|dat|zip|jz|mp3|exe|dds|alpha|rar|spr|dll|pdb|
        pak|xxx|pck|cur|rs|atf|pwz|flv|lnk|psd|pwb|wav)$
        
        &#123;
            expires      240h;
        &#125;

        error_log /Users/canvas/project/django_drf_rimi_teaching/drf_movie_rimi/log/nginx/
        static_error.log;
        access_log /Users/canvas/project/django_drf_rimi_teaching/drf_movie_rimi/log/nginx/
        static_access.log;
    &#125;
&#125;


```
</code></pre>

    </div>

    
    
    

    
    <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束 <i class="fa fa-heart"></i> 感谢阅读-------------</div>

    
        <div class="reward-container">
  <div><p style="font-size:14px; color:#34495e; margin:0 0 5px 0;">赞赏一下吧～ 还可以关注公众号订阅最新内容</p></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/WechatIMG18.png" alt="jwangtec 微信支付">
        <p>微信支付</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>jwangtec
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://www.jwang.cloud/jwangcloud/663967090/" title="Django框架05--语法整理">https://www.jwang.cloud/jwangcloud/663967090/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/python/" rel="tag"><i class="fa fa-tag"></i> python</a>
              <a href="/tags/Django/" rel="tag"><i class="fa fa-tag"></i> Django</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/jwangcloud/3407305082/" rel="prev" title="Django框架04--基础知识">
      <i class="fa fa-chevron-left"></i> Django框架04--基础知识
    </a></div>
      <div class="post-nav-item">
    <a href="/jwangcloud/493232681/" rel="next" title="Django框架06--csrf">
      Django框架06--csrf <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  






          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
      
	<div>

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0-%E7%AC%94%E8%AE%B0%E6%A0%BC%E5%BC%8F%E8%AF%B4%E6%98%8E"><span class="nav-number">1.</span> <span class="nav-text">0.笔记格式说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-restful-api%E7%AE%80%E4%BB%8B"><span class="nav-number">2.</span> <span class="nav-text">1. restful api简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">3.</span> <span class="nav-text">2. 环境搭建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-drf%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B"><span class="nav-number">4.</span> <span class="nav-text">3. drf快速上手</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81"><span class="nav-number">4.1.</span> <span class="nav-text">1. 示例代码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E7%9F%A5%E8%AF%86%E7%82%B9%E8%AE%B2%E8%A7%A3"><span class="nav-number">5.</span> <span class="nav-text">4. 知识点讲解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-views"><span class="nav-number">5.1.</span> <span class="nav-text">1. views</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-serializers"><span class="nav-number">5.2.</span> <span class="nav-text">2. serializers</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F-%E4%BB%96%E5%8F%AA%E8%83%BD%E9%AA%8C%E8%AF%81-dict%E7%9A%84%E6%95%B0%E6%8D%AE-%E8%80%8C%E4%B8%94%E8%B0%83%E7%94%A8%E6%96%B9%E6%B3%95%E4%B9%9F%E4%B8%8D%E4%B8%80%E6%A0%B7"><span class="nav-number">5.2.0.1.</span> <span class="nav-text">注意:他只能验证 dict的数据 而且调用方法也不一样</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-url-%E8%B7%AF%E7%94%B1%E8%A1%A8%E5%AE%9A%E4%B9%89"><span class="nav-number">5.3.</span> <span class="nav-text">3. url 路由表定义</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE"><span class="nav-number"></span> <span class="nav-text">项目</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E9%A1%B9%E7%9B%AE%E7%AE%80%E4%BB%8B"><span class="nav-number">0.1.</span> <span class="nav-text">1. 项目简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E9%A1%B9%E7%9B%AE%E7%99%BB%E5%BD%95"><span class="nav-number">0.2.</span> <span class="nav-text">2.项目登录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E9%A1%B9%E7%9B%AE%E9%A1%B5%E9%9D%A2%E5%B1%95%E7%A4%BA"><span class="nav-number">0.3.</span> <span class="nav-text">3.项目页面展示</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E8%AF%84%E8%AE%BA%E7%B3%BB%E7%BB%9F%E5%92%8C%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6"><span class="nav-number">0.4.</span> <span class="nav-text">4.评论系统和权限控制</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="jwangtec"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">jwangtec</p>
  <div class="site-description" itemprop="description">小脑袋，大智慧</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">146</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">109</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/jwangtec" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jwangtec" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.jianshu.com/u/684433bc744b" title="简书 → https:&#x2F;&#x2F;www.jianshu.com&#x2F;u&#x2F;684433bc744b" rel="noopener" target="_blank"><i class="fa fa-heartbeat fa-fw"></i>简书</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/qq_34536604" title="csdn → https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_34536604" rel="noopener" target="_blank"><i class="fa fa-crosshairs fa-fw"></i>csdn</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://juejin.im/user/5e5c685e6fb9a07cd443bedai" title="掘金 → https:&#x2F;&#x2F;juejin.im&#x2F;user&#x2F;5e5c685e6fb9a07cd443bedai" rel="noopener" target="_blank"><i class="fa fa-spinner fa-fw"></i>掘金</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://app.gitbook.com/@79896867/spaces" title="gitbook → https:&#x2F;&#x2F;app.gitbook.com&#x2F;@79896867&#x2F;spaces" rel="noopener" target="_blank"><i class="fa fa-github fa-fw"></i>gitbook</a>
      </span>
      <span class="links-of-author-item">
        <a href="/jwangtec@163.com" title="E-Mail → jwangtec@163.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.runoob.com/manual/jdk11api/index.html" title="https:&#x2F;&#x2F;www.runoob.com&#x2F;manual&#x2F;jdk11api&#x2F;index.html" rel="noopener" target="_blank">Java11开发文档</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://spring.io/projects/spring-cloud-azure" title="https:&#x2F;&#x2F;spring.io&#x2F;projects&#x2F;spring-cloud-azure" rel="noopener" target="_blank">Spring cloud</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.jwang.cloud/jwangcloud/43383346/" title="https:&#x2F;&#x2F;www.jwang.cloud&#x2F;jwangcloud&#x2F;43383346&#x2F;">设计模式总述</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.jwang.cloud/jwangcloud/2347443716/" title="https:&#x2F;&#x2F;www.jwang.cloud&#x2F;jwangcloud&#x2F;2347443716&#x2F;">Java多线程总述</a>
        </li>
    </ul>
  </div>

      </div>
	
	</div>
	
<div>
  <ul class="sidebar-related-title">
    <li>
      相关文章
    </li>
  </ul>

  <!--noindex-->
  <div class="sidebar-related">
    <ol>
      <li><a href="/jwangcloud/3485546001/" rel="bookmark"><span class="nav-text">Django框架10--项目部署</span></a></li>
      <li><a href="/jwangcloud/2889044135/" rel="bookmark"><span class="nav-text">Django框架09--序列化</span></a></li>
      <li><a href="/jwangcloud/1334139912/" rel="bookmark"><span class="nav-text">Django框架08--请求类型</span></a></li>
      <li><a href="/jwangcloud/3826544670/" rel="bookmark"><span class="nav-text">Django框架07--表单</span></a></li>
      <li><a href="/jwangcloud/493232681/" rel="bookmark"><span class="nav-text">Django框架06--csrf</span></a></li>
    </ol>
  </div>
  <!--/noindex-->
</div>

        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2018 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jwangtec</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">1.6m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">24:30</span>
</div>


<!-- 网站运行时间的设置 -->
<span id="timeDate">载入天数...</span>
<span id="times">载入时分秒...</span>  努力创造未来
<script>
        var now = new Date();
        function createtime() {
            var grt= new Date("01/05/2018 00:00:00");//此处修改你的建站时间或者网站上线时间
            now.setTime(now.getTime()+250);
            days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
            hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
            if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
            mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
            seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
            snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
            document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 ";
            document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
    }
    setInterval("createtime()",250);
</script>


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.6" zIndex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '2UzmUUcYke4dpzoJtJNAzAPL-gzGzoHsz',
      appKey     : 'rdlKv9Hl6K9hnMEp9A1NCRMB',
      placeholder: "留下邮箱，有回复时你将收到提醒，邮箱不会被公开。",
      avatar     : 'wavatar',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
